<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>医生工作量统计 - 统计分析</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:#f5f5f5;
      color:#1f1f1f;
      /* 由页面框架统一控制边距（避免与框架 padding 叠加） */
      padding:0;
      overflow:hidden;
    }

    :root{
      --primary:#1677ff;
      --border:#f0f0f0;
      --card:#fff;
      --muted:#8c8c8c;
      --shadow: 0 2px 8px rgba(0,0,0,.06);
    }

    .page{
      height: 100vh;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .header{
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: 0;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex: 0 0 auto;
    }

    .title{
      font-size: 18px;
      font-weight: 700;
      color:#333;
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 0;
    }

    .tabs{
      display:flex;
      align-items:center;
      gap: 16px;
    }
    .tab{
      font-size: 13px;
      color:#666;
      padding: 6px 0;
      cursor:pointer;
      border-bottom: 2px solid transparent;
      user-select:none;
    }
    .tab.active{
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 700;
    }

    .hidden{ display:none !important; }

    .filters{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .filters-group{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .select, .input{
      height: 32px;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      padding: 0 10px;
      font-size: 13px;
      outline:none;
      background:#fff;
      color:#333;
    }
    .select{ min-width: 140px; }
    .select:focus, .input:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(22,119,255,.18);
    }
    .input{ width: 240px; }

    .btn{
      height: 32px;
      padding: 0 12px;
      border-radius: 6px;
      border: 1px solid #d9d9d9;
      background:#fff;
      cursor:pointer;
      font-size: 13px;
      color:#333;
      user-select:none;
      transition: all .15s ease;
    }
    .btn:hover{ border-color: var(--primary); color: var(--primary); }
    .btn.primary{
      background: var(--primary);
      border-color: var(--primary);
      color:#fff;
    }
    .btn.primary:hover{ background:#4096ff; border-color:#4096ff; color:#fff; }

    .radio-group{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .radio{
      display:flex;
      align-items:center;
      gap: 4px;
      cursor:pointer;
      font-size: 13px;
      color:#666;
      user-select:none;
    }
    .radio input[type="radio"]{
      margin: 0;
      cursor:pointer;
    }
    .radio input[type="radio"]:checked + span{
      color: var(--primary);
      font-weight: 600;
    }

    .content{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      padding: 0 10px 10px 10px;
    }

    .card{
      background: var(--card);
      border-radius: 0;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-hd{
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .card-hd strong{
      font-size: 14px;
      color:#333;
    }

    /* 数据图视图：2x2图表网格，四个容器固定宽度占满页面 */
    .chart-grid{
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 10px;
      width: 100%;
      min-width: 0;
    }

    .chart-module{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 300px;
      min-width: 0;
      overflow: hidden;
    }
    .chart-module-hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-shrink: 0;
    }
    .chart-module-title{
      font-weight: 700;
      font-size: 13px;
      color:#333;
    }
    .chart-module-actions{
      display:flex;
      gap: 6px;
    }
    .chart-module-body{
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-x: auto;
      overflow-y: hidden;
    }
    .bar-chart-area{
      flex: 1 1 auto;
      min-height: 150px;
      min-width: min-content;
      background:#fafafa;
      border-radius: 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#999;
      font-size: 13px;
      position: relative;
      padding: 20px 10px 40px 50px;
    }
    .bar-chart-container{
      flex: 0 0 auto;
      min-width: min-content;
      display:flex;
      align-items:flex-end;
      justify-content:flex-start;
      gap: 8px;
      position: relative;
      height: 100%;
    }
    /* 默认 8 天：柱状图占满容器 */
    .bar-chart-container.fill-width{
      flex: 1;
      min-width: 0;
      width: 100%;
      justify-content: space-around;
    }
    .bar-chart-container.fill-width .bar-group{
      flex: 1;
      max-width: none;
      min-width: 0;
      width: auto;
    }
    /* 超过 8 天：固定柱宽，容器横向滚动 */
    .bar-chart-container.scroll-width{
      flex: 0 0 auto;
      min-width: min-content;
    }
    .bar-chart-container.scroll-width .bar-group{
      flex: 0 0 32px;
      width: 32px;
      min-width: 32px;
      max-width: 80px;
    }
    .bar-group{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 4px;
      flex: 0 0 auto;
      width: 32px;
      max-width: 80px;
      min-width: 28px;
    }
    .bar-wrapper{
      width: 100%;
      height: 100%;
      position: relative;
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }
    .bar{
      width: 100%;
      border-radius: 2px 2px 0 0;
      background: var(--primary);
      position: relative;
      min-height: 2px;
      transition: all .2s ease;
    }
    .bar:hover{
      opacity: 0.8;
    }
    .bar-value{
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: 600;
      color:#333;
      white-space: nowrap;
    }
    .bar-label{
      font-size: 11px;
      color:#666;
      text-align:center;
      margin-top: 4px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      width: 100%;
    }
    .y-axis{
      position: absolute;
      left: 0;
      top: 0;
      bottom: 40px;
      width: 40px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      font-size: 11px;
      color:#999;
      padding-right: 8px;
      text-align:right;
    }
    .chart-table{
      width: max-content;
      min-width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
      border: 1px solid var(--border);
      background:#fff;
    }
    .chart-table th{
      background:#fafafa;
      color:#333;
      font-weight: 700;
      padding: 8px;
      text-align:center;
      border-bottom: 1px solid var(--border);
    }
    .chart-table td{
      padding: 8px;
      text-align:center;
      border-bottom: 1px solid #f5f5f5;
      color:#333;
    }
    .chart-table .col-name{
      text-align:left;
      padding-left: 12px;
    }
    .no-data{
      color:#999;
      font-size: 13px;
      text-align:center;
      padding: 40px;
    }

    /* 汇总表视图：四个环形图 */
    .donut-cards{
      display:grid;
      grid-template-columns: repeat(4, minmax(200px, 1fr));
      gap: 10px;
      padding: 10px;
    }

    .donut-card{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 250px;
    }
    .donut-card-hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .donut-title{
      font-weight: 700;
      font-size: 13px;
      color:#333;
    }
    .donut-body{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 10px;
      align-items:center;
      min-height: 0;
    }
    .donut{
      width: 130px;
      height: 130px;
      border-radius: 50%;
      background: conic-gradient(#4a7dff 0 120deg, #61d836 120deg 200deg, #ffcf3f 200deg 260deg, #ff5a5a 260deg 300deg, #5bc5f7 300deg 340deg, #9c27b0 340deg 360deg);
      position: relative;
      margin: 0 auto;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);
    }
    .donut::after{
      content:"";
      position:absolute;
      inset: 24px;
      background:#fff;
      border-radius: 50%;
      box-shadow: 0 0 0 1px rgba(0,0,0,.05);
    }
    .donut-center{
      position:absolute;
      inset: 24px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      z-index: 2;
      padding: 10px;
      font-weight: 800;
      color:#333;
      line-height: 1.2;
    }
    .donut-center .total{ font-size: 14px; }
    .donut-center .label{ margin-top: 6px; font-size: 12px; color:#666; font-weight: 600; }

    .donut-legend{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 4px;
      font-size: 12px;
      color:#333;
      max-height: 180px;
      overflow-y: auto;
    }
    .donut-legend-item{
      display:grid;
      grid-template-columns: 12px 1fr auto auto;
      gap: 8px;
      align-items:center;
      padding: 3px 6px;
      border-radius: 8px;
      cursor: default;
    }
    .donut-legend-item:hover{
      background:#f5f5f5;
    }
    .dot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background:#4a7dff;
    }
    .dot.c2{ background:#61d836; }
    .dot.c3{ background:#ffcf3f; }
    .dot.c4{ background:#ff5a5a; }
    .dot.c5{ background:#5bc5f7; }
    .dot.c6{ background:#9c27b0; }

    .table-wrap{
      overflow:auto;
      padding: 0 10px 12px 10px;
    }

    table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      min-width: 600px;
      border: 1px solid var(--border);
      background:#fff;
    }
    thead th{
      background:#fafafa;
      color:#333;
      font-weight: 700;
      font-size: 12px;
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      text-align:center;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tbody td{
      font-size: 12px;
      color:#333;
      padding: 10px 8px;
      border-bottom: 1px solid #f5f5f5;
      text-align:center;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    tbody tr:hover{ background:#fafcff; }
    .col-name{ text-align:left; }

    .who{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      min-width:0;
    }
    .avatar{
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background:#e6f4ff;
      border: 1px solid #bae0ff;
      color:#1677ff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      font-weight: 800;
      flex: 0 0 auto;
    }

    /* 弹窗样式 */
    .modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show{
      display: flex;
    }
    .modal{
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 6px 16px rgba(0,0,0,.12);
      min-width: 500px;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header{
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title{
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    .modal-close{
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      color: #999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:hover{
      color: #333;
    }
    .modal-body{
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer{
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
    }
    .modal-form-item{
      margin-bottom: 16px;
    }
    .modal-form-label{
      display: block;
      font-size: 14px;
      color: #333;
      margin-bottom: 8px;
    }
    .detail-table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
      border: 1px solid var(--border);
    }
    .detail-table th{
      background: #fafafa;
      color: #333;
      font-weight: 600;
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .detail-table td{
      padding: 10px 12px;
      border-bottom: 1px solid #f5f5f5;
      color: #333;
    }
    .detail-table tbody tr:hover{
      background: #fafcff;
    }
    .patient-name-link{
      color: var(--primary);
      cursor: pointer;
      text-decoration: none;
    }
    .patient-name-link:hover{
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <div class="title">
        <span>医生工作量统计</span>
        <div class="tabs" role="tablist" aria-label="视图切换">
          <div class="tab active" id="tabChart">数据图</div>
          <div class="tab" id="tabTable">汇总表</div>
        </div>
      </div>
      <div class="filters">
        <!-- 数据图：模式 + 联动筛选值；汇总表：仅模式。第二个下拉仅在数据图页显示 -->
        <select class="select" id="filterMode" title="筛选模式">
          <option value="attending" selected>按主管医生</option>
          <option value="primary">按主诊医生</option>
          <option value="group">按医生组</option>
          <option value="dept">按科室</option>
          <option value="campus">按院区</option>
        </select>
        <span id="filterValueWrap">
          <select class="select" id="filterValue" title="筛选值"></select>
        </span>
        <input type="text" class="input" id="dateRange" placeholder="选择日期范围" title="日期范围" value="2025-12-20 ~ 2025-12-27" />
        <span id="granularityWrap">
        <div class="radio-group" role="group" aria-label="统计粒度">
          <label class="radio">
            <input type="radio" name="timeGranularity" value="day" id="granularityDay" checked>
            <span>按日</span>
          </label>
          <label class="radio">
            <input type="radio" name="timeGranularity" value="month" id="granularityMonth">
            <span>按月</span>
          </label>
        </div>
        </span>
      </div>
    </div>

    <div class="content">
      <!-- 视图1：数据图（默认显示） -->
      <div class="card" id="viewChart">
        <div class="chart-grid">
          <!-- 收治统计 -->
          <div class="chart-module">
            <div class="chart-module-hd">
              <div class="chart-module-title">收治统计</div>
              <div class="chart-module-actions">
                <button class="btn" style="height: 24px; padding: 0 8px; font-size: 11px;">明细</button>
                <button class="btn" style="height: 24px; padding: 0 8px; font-size: 11px;">下载</button>
              </div>
            </div>
            <div class="chart-module-body">
              <div class="bar-chart-area">
                <div class="y-axis" id="admissionYAxis"></div>
                <div class="bar-chart-container" id="admissionBarChart"></div>
              </div>
              <table class="chart-table">
                <thead>
                  <tr>
                    <th class="col-name" style="text-align:left; padding-left:12px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="admissionTableBody"></tbody>
              </table>
            </div>
          </div>

          <!-- 靶区勾画统计（可配置：关联菜单） -->
          <div class="chart-module">
            <div class="chart-module-hd">
              <div class="chart-module-title" id="contouringPanelTitleA">靶区勾画统计</div>
              <div class="chart-module-actions">
                <button class="btn" id="btnContouringDetailA" style="height: 24px; padding: 0 8px; font-size: 11px;">明细</button>
                <button class="btn" id="btnContouringDownloadA" style="height: 24px; padding: 0 8px; font-size: 11px;">下载</button>
                <button class="btn" id="btnContouringSettingA" title="设置" aria-label="设置" style="height: 24px; width: 24px; padding: 0; font-size: 14px; line-height: 24px;">⚙</button>
              </div>
            </div>
            <div class="chart-module-body">
              <div class="bar-chart-area">
                <div class="y-axis" id="contouringYAxisA"></div>
                <div class="bar-chart-container" id="contouringBarChartA"></div>
              </div>
              <table class="chart-table">
                <thead>
                  <tr>
                    <th class="col-name" style="text-align:left; padding-left:12px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="contouringTableBodyA">
                </tbody>
              </table>
            </div>
          </div>

          <!-- 靶区勾画统计（可配置：关联菜单） - 替换原 CT预约统计 -->
          <div class="chart-module">
            <div class="chart-module-hd">
              <div class="chart-module-title" id="contouringPanelTitleB">靶区勾画统计</div>
              <div class="chart-module-actions">
                <button class="btn" id="btnContouringDetailB" style="height: 24px; padding: 0 8px; font-size: 11px;">明细</button>
                <button class="btn" id="btnContouringDownloadB" style="height: 24px; padding: 0 8px; font-size: 11px;">下载</button>
                <button class="btn" id="btnContouringSettingB" title="设置" aria-label="设置" style="height: 24px; width: 24px; padding: 0; font-size: 14px; line-height: 24px;">⚙</button>
              </div>
            </div>
            <div class="chart-module-body">
              <div class="bar-chart-area">
                <div class="y-axis" id="contouringYAxisB"></div>
                <div class="bar-chart-container" id="contouringBarChartB"></div>
              </div>
              <table class="chart-table">
                <thead>
                  <tr>
                    <th class="col-name" style="text-align:left; padding-left:12px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="contouringTableBodyB">
                </tbody>
              </table>
            </div>
          </div>

          <!-- 靶区勾画统计（可配置：关联菜单） - 替换原 勾画审核统计 -->
          <div class="chart-module">
            <div class="chart-module-hd">
              <div class="chart-module-title" id="contouringPanelTitleC">靶区勾画统计</div>
              <div class="chart-module-actions">
                <button class="btn" id="btnContouringDetailC" style="height: 24px; padding: 0 8px; font-size: 11px;">明细</button>
                <button class="btn" id="btnContouringDownloadC" style="height: 24px; padding: 0 8px; font-size: 11px;">下载</button>
                <button class="btn" id="btnContouringSettingC" title="设置" aria-label="设置" style="height: 24px; width: 24px; padding: 0; font-size: 14px; line-height: 24px;">⚙</button>
              </div>
            </div>
            <div class="chart-module-body">
              <div class="bar-chart-area">
                <div class="y-axis" id="contouringYAxisC"></div>
                <div class="bar-chart-container" id="contouringBarChartC"></div>
              </div>
              <table class="chart-table">
                <thead>
                  <tr>
                    <th class="col-name" style="text-align:left; padding-left:12px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="contouringTableBodyC">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 视图2：汇总表 -->
      <div class="card hidden" id="viewTable">
        <div class="donut-cards">
          <!-- 收治统计 -->
          <div class="donut-card">
            <div class="donut-card-hd">
              <div class="donut-title">收治统计</div>
            </div>
            <div class="donut-body">
              <div class="donut">
                <div class="donut-center">
                  <div>
                    <div class="total" id="totalAdmission">35</div>
                    <div class="label">总数</div>
                  </div>
                </div>
              </div>
              <div class="donut-legend" id="legend1"></div>
            </div>
          </div>

          <!-- 靶区勾画统计 -->
          <div class="donut-card">
            <div class="donut-card-hd">
              <div class="donut-title">靶区勾画统计</div>
            </div>
            <div class="donut-body">
              <div class="donut">
                <div class="donut-center">
                  <div>
                    <div class="total" id="totalTargetContour">0</div>
                    <div class="label">总数</div>
                  </div>
                </div>
              </div>
              <div class="donut-legend" id="legend2"></div>
            </div>
          </div>

          <!-- 医师核准统计 -->
          <div class="donut-card">
            <div class="donut-card-hd">
              <div class="donut-title">医师核准统计</div>
            </div>
            <div class="donut-body">
              <div class="donut">
                <div class="donut-center">
                  <div>
                    <div class="total" id="totalDoctorApproval">0</div>
                    <div class="label">总数</div>
                  </div>
                </div>
              </div>
              <div class="donut-legend" id="legend3"></div>
            </div>
          </div>

          <!-- 勾画审核统计 -->
          <div class="donut-card">
            <div class="donut-card-hd">
              <div class="donut-title">勾画审核统计</div>
            </div>
            <div class="donut-body">
              <div class="donut">
                <div class="donut-center">
                  <div>
                    <div class="total" id="totalReview">0</div>
                    <div class="label">总数</div>
                  </div>
                </div>
              </div>
              <div class="donut-legend" id="legend4"></div>
            </div>
          </div>
        </div>

        <!-- 汇总表 -->
        <div class="card-hd">
          <strong>汇总表</strong>
          <button class="btn primary" id="btnExport">导出</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th id="summaryTableFirstHeader" style="width: 200px; text-align:left; padding-left:12px;">主管医生</th>
                <th>收治</th>
                <th>靶区勾画</th>
                <th>医师核准</th>
                <th>勾画审核</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 设置弹窗 -->
  <div class="modal-overlay" id="settingModal">
    <div class="modal" style="min-width: 400px;">
      <div class="modal-header">
        <div class="modal-title">设置</div>
        <button class="modal-close" onclick="closeModal('settingModal')">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-form-item">
          <label class="modal-form-label">关联菜单</label>
          <select class="select" id="menuSelect" style="width: 100%;">
            <option value="patient-list">患者列表</option>
            <option value="patient-register">患者登记</option>
            <option value="ct-appointment">CT预约</option>
            <option value="ct-queue-call">CT排队叫号</option>
            <option value="organ-contouring">正常组织勾画</option>
            <option value="target-contouring" selected>靶区勾画</option>
            <option value="review">勾画审核</option>
            <option value="plan-design">计划设计</option>
            <option value="plan-evaluate">计划评估</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('settingModal')">取消</button>
        <button class="btn primary" onclick="saveSetting()">确定</button>
      </div>
    </div>
  </div>

  <!-- 明细弹窗 -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal" style="min-width: 900px; max-width: 95vw;">
      <div class="modal-header">
        <div class="modal-title">勾画明细</div>
        <button class="modal-close" onclick="closeModal('detailModal')">×</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 12px; display: flex; justify-content: flex-end;">
          <button class="btn primary" id="btnExportDetail" style="height: 32px;">导出到XLS</button>
        </div>
        <div style="overflow-x: auto;">
          <table class="detail-table">
            <thead>
              <tr>
                <th>患者名称</th>
                <th>病案号</th>
                <th>放疗号</th>
                <th>主管医生</th>
                <th>医生组</th>
                <th>诊断</th>
                <th>流程</th>
                <th>提交时间</th>
              </tr>
            </thead>
            <tbody id="detailTableBody">
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('detailModal')">关闭</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // 全局筛选：院区 / 科室（方案A）
    // 说明：原型使用模拟事件数据，通过筛选后重新聚合，驱动所有图表/表格/明细/导出占位
    // -----------------------------
    const campusOptions = [
      { id: 'all', name: '全部院区' },
      { id: 'c1', name: '本部院区' },
      { id: 'c2', name: '东院区' }
    ];
    const deptOptions = [
      { id: 'all', campusId: 'all', name: '全部科室' },
      { id: 'd1', campusId: 'c1', name: '放疗科' },
      { id: 'd2', campusId: 'c1', name: '肿瘤科' },
      { id: 'd3', campusId: 'c2', name: '放疗科' },
      { id: 'd4', campusId: 'c2', name: '介入科' }
    ];

    function $(id){ return document.getElementById(id); }

    // -----------------------------
    // 查询条件：数据图用“模式+联动筛选值”，汇总表仅用“模式”（opts.forSummary 时 value 为空）
    // -----------------------------
    const filterValueData = {
      attending: ['王医生', '刘医生', '陈医生', '邓霞', '阿郎'],
      primary: ['chhys', '测试主诊A', '测试主诊B', '王医生'],
      group: ['王医生组', '刘医生组', '陈医生组', '测试医生组'],
      dept: ['放疗科', '肿瘤科', '介入科', '核医学科'],
      campus: ['本部院区', '东院区', '南院区']
    };

    function getActiveFilter(opts){
      const granularityEl = document.querySelector('input[name="timeGranularity"]:checked');
      const forSummary = opts && opts.forSummary;
      return {
        mode: $('filterMode')?.value || 'attending',
        value: forSummary ? '' : ($('filterValue')?.value || ''),
        dateRange: $('dateRange')?.value || '',
        granularity: granularityEl ? granularityEl.value : 'month'
      };
    }

    function updateFilterValueOptions(){
      const mode = $('filterMode')?.value || 'attending';
      const list = filterValueData[mode] || [];
      const el = $('filterValue');
      if (!el) return;
      el.innerHTML = '';
      list.forEach((name) => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        el.appendChild(opt);
      });
      if (el.options.length > 0) el.selectedIndex = 0;
    }

    // 解析日期范围字符串，返回 { start: 'YYYY-MM', end: 'YYYY-MM' }
    function parseDateRange(dateRangeStr){
      if (!dateRangeStr || !String(dateRangeStr).trim()) return { start: null, end: null };
      const parts = String(dateRangeStr).split('~').map(s => s.trim());
      const startStr = parts[0] || '';
      const endStr = parts[1] || parts[0] || '';
      const start = startStr.length >= 7 ? startStr.substring(0, 7) : null;
      const end = endStr.length >= 7 ? endStr.substring(0, 7) : null;
      return { start, end };
    }

    // 解析日期范围为完整日期 YYYY-MM-DD（用于按日维度）
    function parseDateRangeFull(dateRangeStr){
      if (!dateRangeStr || !String(dateRangeStr).trim()) return { start: null, end: null };
      const parts = String(dateRangeStr).split('~').map(s => s.trim());
      const startStr = (parts[0] || '').trim();
      const endStr = (parts[1] || parts[0] || '').trim();
      const toDate = (s) => {
        if (s.length >= 10) return s.substring(0, 10);
        if (s.length >= 7) return s + '-01';
        return null;
      };
      return { start: toDate(startStr), end: toDate(endStr) };
    }

    // 生成范围内的日期列表（与查询条件默认日期范围一致），最多 31 天便于展示
    function getDatesInRange(startDate, endDate){
      if (!startDate || !endDate || startDate > endDate) return [];
      const list = [];
      const start = new Date(startDate);
      const end = new Date(endDate);
      const maxDays = 31;
      for (let d = new Date(start), n = 0; d <= end && n < maxDays; d.setDate(d.getDate() + 1), n++) {
        list.push(d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'));
      }
      return list;
    }

    // 按日期范围过滤事件（事件需有 month: 'YYYY-MM'）
    function applyDateRangeFilter(list, dateRangeStr){
      const { start, end } = parseDateRange(dateRangeStr);
      if (!start || !end) return list || [];
      return (list || []).filter(e => {
        const m = e.month || '';
        return m >= start && m <= end;
      });
    }

    // 按完整日期范围过滤（按日维度时用，事件用 date 或 month+'-01'）
    function applyDateRangeFilterFull(list, dateRangeStr){
      const { start, end } = parseDateRangeFull(dateRangeStr);
      if (!start || !end) return list || [];
      return (list || []).filter(e => {
        const d = e.date || (e.month ? e.month + '-01' : '');
        return d >= start && d <= end;
      });
    }

    function updateDeptOptionsFor(campusSelectId, deptSelectId){
      const campusId = $(campusSelectId)?.value || 'all';
      const deptSelect = $(deptSelectId);
      if (!deptSelect) return;
      const prev = deptSelect.value || 'all';

      const list = deptOptions.filter(d => d.id === 'all' || campusId === 'all' || d.campusId === campusId);
      deptSelect.innerHTML = '';
      list.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.name;
        deptSelect.appendChild(opt);
      });

      // 若之前选择的科室不在新列表中，则回退为 all
      const stillExists = Array.from(deptSelect.options).some(o => o.value === prev);
      deptSelect.value = stillExists ? prev : 'all';
    }

    function initCampusDeptFiltersFor(campusSelectId, deptSelectId){
      const campusSelect = $(campusSelectId);
      if (campusSelect) {
        campusSelect.innerHTML = '';
        campusOptions.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name;
          campusSelect.appendChild(opt);
        });
        campusSelect.value = 'all';
      }
      updateDeptOptionsFor(campusSelectId, deptSelectId);
    }

    // -----------------------------
    // 模拟数据（事件级）——用于展示筛选联动效果
    // -----------------------------
    const months = ['2025-07','2025-08','2025-09','2025-10','2025-11','2025-12','2026-01'];

    function dotClassByIndex(i){
      const dots = ['c1','c2','c3','c4','c5','c6'];
      return dots[i % dots.length];
    }

    function getDeptNameById(deptId){
      const hit = (deptOptions || []).find(d => d.id === deptId);
      return hit?.name || '未知科室';
    }

    function getCampusNameById(campusId){
      const hit = (campusOptions || []).find(c => c.id === campusId);
      return hit?.name || '未知院区';
    }

    // type: admission | ct | contour；按日维度用 date（YYYY-MM-DD），缺省时用 month+'-01'
    // 默认日期范围 2025-12-20～2025-12-31，虚拟数据覆盖该区间
    const mockEvents = [
      // admission（收治）——2025-12-20～31
      { type:'admission', month:'2025-12', date:'2025-12-20', count:3, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'admission', month:'2025-12', date:'2025-12-21', count:2, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'admission', month:'2025-12', date:'2025-12-22', count:4, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'admission', month:'2025-12', date:'2025-12-23', count:1, doctor:'陈医生', doctorGroup:'陈医生组', campusId:'c2', deptId:'d4' },
      { type:'admission', month:'2025-12', date:'2025-12-24', count:2, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'admission', month:'2025-12', date:'2025-12-25', count:5, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'admission', month:'2025-12', date:'2025-12-26', count:2, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'admission', month:'2025-12', date:'2025-12-27', count:3, doctor:'阿郎', doctorGroup:'王医生组', campusId:'c1', deptId:'d2' },
      { type:'admission', month:'2025-12', date:'2025-12-28', count:1, doctor:'陈医生', doctorGroup:'陈医生组', campusId:'c2', deptId:'d4' },
      { type:'admission', month:'2025-12', date:'2025-12-29', count:2, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'admission', month:'2025-12', date:'2025-12-30', count:4, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'admission', month:'2025-12', date:'2025-12-31', count:2, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },

      // ct（CT预约）——汇总表用
      { type:'ct', month:'2025-12', date:'2025-12-22', count:3, doctor:'阿郎', doctorGroup:'王医生组', campusId:'c1', deptId:'d2' },
      { type:'ct', month:'2025-12', date:'2025-12-25', count:5, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'ct', month:'2025-12', date:'2025-12-28', count:2, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },

      // contour 靶区勾画——2025-12-20～31
      { type:'contour', menuValue:'target-contouring', month:'2025-12', date:'2025-12-20', count:6, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'target-contouring', month:'2025-12', date:'2025-12-21', count:4, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'target-contouring', month:'2025-12', date:'2025-12-22', count:8, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'target-contouring', month:'2025-12', date:'2025-12-23', count:3, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'target-contouring', month:'2025-12', date:'2025-12-24', count:5, doctor:'陈医生', doctorGroup:'陈医生组', campusId:'c2', deptId:'d4' },
      { type:'contour', menuValue:'target-contouring', month:'2025-12', date:'2025-12-25', count:7, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'target-contouring', month:'2025-12', date:'2025-12-26', count:4, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'target-contouring', month:'2025-12', date:'2025-12-28', count:6, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'target-contouring', month:'2025-12', date:'2025-12-30', count:5, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'target-contouring', month:'2025-12', date:'2025-12-31', count:2, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },

      // contour 医师核准——2025-12-20～31
      { type:'contour', menuValue:'doctor-approve', month:'2025-12', date:'2025-12-20', count:4, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'doctor-approve', month:'2025-12', date:'2025-12-21', count:2, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'doctor-approve', month:'2025-12', date:'2025-12-23', count:5, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'doctor-approve', month:'2025-12', date:'2025-12-24', count:3, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'doctor-approve', month:'2025-12', date:'2025-12-26', count:6, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'doctor-approve', month:'2025-12', date:'2025-12-27', count:2, doctor:'陈医生', doctorGroup:'陈医生组', campusId:'c2', deptId:'d4' },
      { type:'contour', menuValue:'doctor-approve', month:'2025-12', date:'2025-12-29', count:4, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'doctor-approve', month:'2025-12', date:'2025-12-31', count:3, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },

      // contour 勾画审核——2025-12-20～31
      { type:'contour', menuValue:'review', month:'2025-12', date:'2025-12-20', count:3, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'review', month:'2025-12', date:'2025-12-22', count:7, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'review', month:'2025-12', date:'2025-12-23', count:4, doctor:'陈医生', doctorGroup:'陈医生组', campusId:'c2', deptId:'d4' },
      { type:'contour', menuValue:'review', month:'2025-12', date:'2025-12-24', count:2, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'review', month:'2025-12', date:'2025-12-25', count:5, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'review', month:'2025-12', date:'2025-12-27', count:6, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'review', month:'2025-12', date:'2025-12-28', count:3, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'review', month:'2025-12', date:'2025-12-30', count:4, doctor:'陈医生', doctorGroup:'陈医生组', campusId:'c2', deptId:'d4' },
      { type:'contour', menuValue:'review', month:'2025-12', date:'2025-12-31', count:2, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },

      // contour 计划评估——2025-12-20～27（第三个数据图面板）
      { type:'contour', menuValue:'plan-evaluate', month:'2025-12', date:'2025-12-20', count:2, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'plan-evaluate', month:'2025-12', date:'2025-12-21', count:3, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'plan-evaluate', month:'2025-12', date:'2025-12-22', count:5, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'plan-evaluate', month:'2025-12', date:'2025-12-23', count:2, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'plan-evaluate', month:'2025-12', date:'2025-12-24', count:4, doctor:'陈医生', doctorGroup:'陈医生组', campusId:'c2', deptId:'d4' },
      { type:'contour', menuValue:'plan-evaluate', month:'2025-12', date:'2025-12-25', count:6, doctor:'王医生', doctorGroup:'王医生组', campusId:'c1', deptId:'d1' },
      { type:'contour', menuValue:'plan-evaluate', month:'2025-12', date:'2025-12-26', count:3, doctor:'刘医生', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' },
      { type:'contour', menuValue:'plan-evaluate', month:'2025-12', date:'2025-12-27', count:4, doctor:'邓霞', doctorGroup:'刘医生组', campusId:'c2', deptId:'d3' }
    ];
    function applyEventFilters(list, filter){
      const { mode, value } = filter || { mode: 'attending', value: '' };
      return (list || []).filter(e => {
        if (!value) return true;
        if (mode === 'group') return (e.doctorGroup || '') === value;
        if (mode === 'dept') return getDeptNameById(e.deptId) === value;
        if (mode === 'campus') return getCampusNameById(e.campusId) === value;
        // attending / primary：原型统一按 doctor 口径过滤
        return (e.doctor || '') === value;
      });
    }

    function applyDetailFilters(list, filter){
      const { mode, value } = filter || { mode: 'attending', value: '' };
      return (list || []).filter(e => {
        if (!value) return true;
        if (mode === 'group') return (e.group || '') === value;
        if (mode === 'dept') return getDeptNameById(e.deptId) === value;
        if (mode === 'campus') return getCampusNameById(e.campusId) === value;
        // attending / primary：原型统一按 doctor 口径过滤
        return (e.doctor || '') === value;
      });
    }

    function sumByMonth(list){
      const map = new Map();
      months.forEach(m => map.set(m, 0));
      (list || []).forEach(e => {
        map.set(e.month, (map.get(e.month) || 0) + (e.count || 0));
      });
      return months.map(m => ({ month: m, value: map.get(m) || 0 }));
    }

    // 按日聚合：事件用 date 或 month+'-01' 作为日期键，与查询条件日期范围一致
    function sumByDay(list, dates){
      const map = new Map();
      dates.forEach(d => map.set(d, 0));
      (list || []).forEach(e => {
        const d = e.date || (e.month ? e.month + '-01' : '');
        if (map.has(d)) map.set(d, (map.get(d) || 0) + (e.count || 0));
      });
      return dates.map(d => ({ month: d, value: map.get(d) || 0 }));
    }

    function groupByDoctor(list){
      const map = new Map();
      (list || []).forEach(e => {
        const k = e.doctor || '未知';
        map.set(k, (map.get(k) || 0) + (e.count || 0));
      });
      const arr = Array.from(map.entries()).map(([name, count]) => ({ name, count }));
      const total = arr.reduce((s, it) => s + it.count, 0) || 1;
      return arr
        .sort((a,b) => b.count - a.count)
        .map((it, idx) => ({ name: it.name, count: it.count, pct: (it.count / total) * 100, dot: dotClassByIndex(idx) }));
    }

    function groupByCampus(list){
      const map = new Map();
      (list || []).forEach(e => {
        const k = getCampusNameById(e.campusId) || '未知院区';
        map.set(k, (map.get(k) || 0) + (e.count || 0));
      });
      const arr = Array.from(map.entries()).map(([name, count]) => ({ name, count }));
      const total = arr.reduce((s, it) => s + it.count, 0) || 1;
      return arr
        .sort((a,b) => b.count - a.count)
        .map((it, idx) => ({ name: it.name, count: it.count, pct: (it.count / total) * 100, dot: dotClassByIndex(idx) }));
    }

    function buildSummaryRows(listAdmission, listTargetContour, listDoctorApproval, listReview, groupBy){
      // groupBy: 'doctor' | 'campus' —— 按主管医生或按院区聚合
      const byCampus = groupBy === 'campus';
      const getKey = byCampus ? (e) => getCampusNameById(e.campusId) || '未知院区' : (e) => e.doctor || '未知';
      const rows = new Map();
      function add(list, key){
        (list || []).forEach(e => {
          const name = getKey(e);
          if (!rows.has(name)) rows.set(name, { name, init: name.slice(0,1), admission:0, targetContouring:0, doctorApproval:0, review:0 });
          rows.get(name)[key] += (e.count || 0);
        });
      }
      add(listAdmission, 'admission');
      add(listTargetContour, 'targetContouring');
      add(listDoctorApproval, 'doctorApproval');
      add(listReview, 'review');
      return Array.from(rows.values()).sort((a,b) =>
        (b.admission + b.targetContouring + b.doctorApproval + b.review) -
        (a.admission + a.targetContouring + a.doctorApproval + a.review));
    }

    const contouringPanelKeys = ['A', 'B', 'C'];

    // 三个面板的“关联菜单”配置（默认：A=靶区勾画，B=勾画审核，C=计划评估）
    const contouringPanelConfig = {
      A: { menuValue: 'target-contouring', menuLabel: '靶区勾画' },
      B: { menuValue: 'review', menuLabel: '勾画审核' },
      C: { menuValue: 'plan-evaluate', menuLabel: '计划评估' }
    };
    let activeContouringPanelKey = 'A';

    const contouringDetailData = [
      { patientName: '张三', caseNo: 'C202501001', rtNo: 'RT202501001', doctor: '王医生', group: '王医生组', diagnosis: '鼻咽癌', process: '外照射流程', submitTime: '2025-12-15 14:30:25', campusId:'c1', deptId:'d1' },
      { patientName: '李四', caseNo: 'C202501002', rtNo: 'RT202501002', doctor: '王医生', group: '王医生组', diagnosis: '肺癌', process: '外照射流程', submitTime: '2025-12-15 16:20:10', campusId:'c1', deptId:'d2' },
      { patientName: '王五', caseNo: 'C202501003', rtNo: 'RT202501003', doctor: '刘医生', group: '刘医生组', diagnosis: '乳腺癌', process: 'SBRT流程', submitTime: '2025-12-16 09:15:30', campusId:'c2', deptId:'d3' },
      { patientName: '赵六', caseNo: 'C202501004', rtNo: 'RT202501004', doctor: '王医生', group: '王医生组', diagnosis: '食管癌', process: '外照射流程', submitTime: '2025-12-16 11:45:20', campusId:'c1', deptId:'d1' }
    ];

    // （原型）汇总表与 donut 图例数据将由 refreshSummary() 动态生成

    function renderLegend(containerId, data) {
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = '';
      data.forEach((it) => {
        const row = document.createElement('div');
        row.className = 'donut-legend-item';
        row.innerHTML = `
          <span class="dot ${it.dot}"></span>
          <span class="name" title="${it.name}" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${it.name}</span>
          <span class="num" style="color:#555; font-variant-numeric: tabular-nums;">${it.count}</span>
          <span class="pct" style="color:#999; font-variant-numeric: tabular-nums;">${it.pct.toFixed(2)}%</span>
        `;
        el.appendChild(row);
      });
    }

    function renderTable() {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      (window.__summaryRows || []).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="col-name" style="padding-left:12px;">
            <span class="who"><span class="avatar">${row.init}</span><span title="${row.name}">${row.name}</span></span>
          </td>
          <td>${row.admission}</td>
          <td>${row.targetContouring}</td>
          <td>${row.doctorApproval}</td>
          <td>${row.review}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 渲染通用柱状图（单序列）；≤8 天占满容器，>8 天横向滚动
    function renderSimpleBarChart(containerId, yAxisId, data) {
      const container = document.getElementById(containerId);
      const yAxis = document.getElementById(yAxisId);
      if (!container || !yAxis) return;
      
      container.innerHTML = '';
      yAxis.innerHTML = '';
      container.className = 'bar-chart-container ' + (data.length <= 8 ? 'fill-width' : 'scroll-width');
      
      const maxValue = Math.max(...data.map(d => d.value), 1);
      const barHeight = 120; // 柱子最大高度（px）
      
      // 渲染Y轴刻度（简化：3段）
      const ticks = maxValue <= 1 ? [1,0] : [maxValue, Math.floor(maxValue/2), 0];
      ticks.forEach(t => {
        const tick = document.createElement('div');
        tick.textContent = t;
        yAxis.appendChild(tick);
      });
      
      // 渲染柱状图
      data.forEach(item => {
        const barGroup = document.createElement('div');
        barGroup.className = 'bar-group';
        
        const barWrapper = document.createElement('div');
        barWrapper.className = 'bar-wrapper';
        
        const bar = document.createElement('div');
        bar.className = 'bar';
        const height = (item.value / maxValue) * barHeight;
        bar.style.height = height + 'px';
        
        // 显示数值
        if (item.value > 0) {
          const valueLabel = document.createElement('div');
          valueLabel.className = 'bar-value';
          valueLabel.textContent = item.value;
          bar.appendChild(valueLabel);
        }
        
        barWrapper.appendChild(bar);
        
        // 标签：按月显示 "07"，按日显示 "07-01"
        const label = document.createElement('div');
        label.className = 'bar-label';
        label.textContent = item.month.substring(5); // 按月 "07"，按日 "07-01"
        label.title = item.month;
        
        barGroup.appendChild(barWrapper);
        barGroup.appendChild(label);
        container.appendChild(barGroup);
      });
    }

    // 渲染面板表格（与柱状图同数据，列数随按日/按月动态）
    function renderContouringPanelTable(tbodyId, data, groupLabel = '王医生组') {
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      tbody.innerHTML = '';
      const cells = (data || []).map(d => `<td>${d.value ?? 0}</td>`).join('');
      const row = document.createElement('tr');
      row.innerHTML = `<td class="col-name" style="padding-left:12px;">${groupLabel}</td>${cells}`;
      tbody.appendChild(row);
    }

    // 渲染勾画明细表格
    function renderContouringDetailTable() {
      const tbody = document.getElementById('detailTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const filtered = applyDetailFilters(contouringDetailData, getActiveFilter());
      filtered.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="#" class="patient-name-link" onclick="alert('原型占位：跳转到患者详情页 - ${item.patientName}'); return false;">${item.patientName}</a></td>
          <td>${item.caseNo}</td>
          <td>${item.rtNo}</td>
          <td>${item.doctor}</td>
          <td>${item.group}</td>
          <td>${item.diagnosis}</td>
          <td>${item.process}</td>
          <td>${item.submitTime}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // 弹窗控制函数
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('show');
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('show');
      }
    }

    function updateContouringPanelTitle(panelKey) {
      const cfg = contouringPanelConfig[panelKey];
      const titleEl = document.getElementById(`contouringPanelTitle${panelKey}`);
      if (!cfg || !titleEl) return;
      titleEl.textContent = `${cfg.menuLabel}统计`;
    }

    function saveSetting() {
      const menuSelect = document.getElementById('menuSelect');
      const label = menuSelect.options[menuSelect.selectedIndex]?.text || '靶区勾画';
      contouringPanelConfig[activeContouringPanelKey] = {
        menuValue: menuSelect.value,
        menuLabel: label
      };
      updateContouringPanelTitle(activeContouringPanelKey);
      alert(`原型占位：保存设置 - 关联菜单：${label}`);
      closeModal('settingModal');
    }

    function openContouringSetting(panelKey) {
      activeContouringPanelKey = panelKey;
      const menuSelect = document.getElementById('menuSelect');
      if (menuSelect) {
        menuSelect.value = contouringPanelConfig[panelKey]?.menuValue || 'target-contouring';
      }
      openModal('settingModal');
    }

    // 渲染收治统计柱状图；≤8 天占满容器，>8 天横向滚动
    function renderAdmissionBarChart() {
      const container = document.getElementById('admissionBarChart');
      const yAxis = document.getElementById('admissionYAxis');
      if (!container || !yAxis) return;
      
      container.innerHTML = '';
      yAxis.innerHTML = '';

      const series = window.__admissionSeries || months.map(m => ({ month:m, value:0 }));
      container.className = 'bar-chart-container ' + (series.length <= 8 ? 'fill-width' : 'scroll-width');
      const maxValue = Math.max(...series.map(d => d.value), 1);
      const barHeight = 120;
      const ticks = maxValue <= 1 ? [1,0] : [maxValue, Math.floor(maxValue/2), 0];
      ticks.forEach(t => {
        const tick = document.createElement('div');
        tick.textContent = t;
        yAxis.appendChild(tick);
      });

      series.forEach(item => {
        const barGroup = document.createElement('div');
        barGroup.className = 'bar-group';
        
        const barWrapper = document.createElement('div');
        barWrapper.className = 'bar-wrapper';
        
        const bar = document.createElement('div');
        bar.className = 'bar';
        const height = (item.value / maxValue) * barHeight;
        bar.style.height = height + 'px';
        
        // 显示数值
        if (item.value > 0) {
          const valueLabel = document.createElement('div');
          valueLabel.className = 'bar-value';
          valueLabel.textContent = item.value;
          bar.appendChild(valueLabel);
        }
        
        barWrapper.appendChild(bar);
        
        // 月份标签
        const label = document.createElement('div');
        label.className = 'bar-label';
        label.textContent = item.month.substring(5); // 按月 "07"，按日 "07-01"
        label.title = item.month;
        
        barGroup.appendChild(barWrapper);
        barGroup.appendChild(label);
        container.appendChild(barGroup);
      });
    }

    function renderAdmissionTable(){
      const tbody = $('admissionTableBody');
      if (!tbody) return;
      const series = window.__admissionSeries || months.map(m => ({ month:m, value:0 }));
      const groupLabel = $('filterValue')?.options[$('filterValue').selectedIndex]?.text || '全部';
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="col-name" style="padding-left:12px;">${groupLabel}</td>
        ${series.map(it => `<td>${it.value}</td>`).join('')}
      `;
      tbody.innerHTML = '';
      tbody.appendChild(row);
    }

    // 更新数据图四个统计表格的表头（与当前维度一致：按日显示日期，按月显示月份）
    function updateChartTableHeaders(series){
      const labels = (series || []).map(d => d.month.substring(5));
      const theadSelectors = ['admissionTableBody', 'contouringTableBodyA', 'contouringTableBodyB', 'contouringTableBodyC'];
      theadSelectors.forEach(tbodyId => {
        const tbody = $(tbodyId);
        if (!tbody) return;
        const tr = tbody.closest('table')?.querySelector('thead tr');
        if (!tr) return;
        tr.innerHTML = '<th class="col-name" style="text-align:left; padding-left:12px;"></th>' + labels.map(l => `<th>${l}</th>`).join('');
      });
    }

    function refreshChart(){
      const filter = getActiveFilter();
      const isDay = filter.granularity === 'day';
      let filtered;
      let admissionSeries;
      let dateList;

      if (isDay) {
        const { start, end } = parseDateRangeFull(filter.dateRange);
        dateList = getDatesInRange(start, end);
        filtered = applyEventFilters(applyDateRangeFilterFull(mockEvents, filter.dateRange), filter);
        const admissions = filtered.filter(e => e.type === 'admission');
        const contours = filtered.filter(e => e.type === 'contour');
        admissionSeries = sumByDay(admissions, dateList);
        window.__admissionSeries = admissionSeries;
        updateChartTableHeaders(admissionSeries);
        renderAdmissionBarChart();
        renderAdmissionTable();
        const groupLabel = $('filterValue')?.options[$('filterValue').selectedIndex]?.text || '全部';
        contouringPanelKeys.forEach((k) => {
          const menuValue = contouringPanelConfig[k]?.menuValue;
          const series = sumByDay(contours.filter(e => e.menuValue === menuValue), dateList);
          renderSimpleBarChart(`contouringBarChart${k}`, `contouringYAxis${k}`, series);
          renderContouringPanelTable(`contouringTableBody${k}`, series, groupLabel);
        });
      } else {
        filtered = applyEventFilters(applyDateRangeFilter(mockEvents, filter.dateRange), filter);
        const admissions = filtered.filter(e => e.type === 'admission');
        const contours = filtered.filter(e => e.type === 'contour');
        admissionSeries = sumByMonth(admissions);
        window.__admissionSeries = admissionSeries;
        updateChartTableHeaders(admissionSeries);
        renderAdmissionBarChart();
        renderAdmissionTable();
        const groupLabel = $('filterValue')?.options[$('filterValue').selectedIndex]?.text || '全部';
        contouringPanelKeys.forEach((k) => {
          const menuValue = contouringPanelConfig[k]?.menuValue;
          const series = sumByMonth(contours.filter(e => e.menuValue === menuValue));
          renderSimpleBarChart(`contouringBarChart${k}`, `contouringYAxis${k}`, series);
          renderContouringPanelTable(`contouringTableBody${k}`, series, groupLabel);
        });
      }
    }

    function refreshSummary(){
      const filter = getActiveFilter({ forSummary: true });
      let byDate = applyDateRangeFilter(mockEvents, filter.dateRange);
      const filtered = applyEventFilters(byDate, filter);
      const admissions = filtered.filter(e => e.type === 'admission');
      const contours = filtered.filter(e => e.type === 'contour');
      const targetContours = contours.filter(e => e.menuValue === 'target-contouring');
      const doctorApprovals = contours.filter(e => e.menuValue === 'doctor-approve');
      const reviews = contours.filter(e => e.menuValue === 'review');

      const byCampus = filter.mode === 'campus';
      const groupBy = byCampus ? 'campus' : 'doctor';
      const groupFn = byCampus ? groupByCampus : groupByDoctor;

      const admissionLegend = groupFn(admissions);
      const targetContourLegend = groupFn(targetContours);
      const doctorApprovalLegend = groupFn(doctorApprovals);
      const reviewLegend = groupFn(reviews);
      renderLegend('legend1', admissionLegend);
      renderLegend('legend2', targetContourLegend);
      renderLegend('legend3', doctorApprovalLegend);
      renderLegend('legend4', reviewLegend);

      const totalAdmission = admissions.reduce((s, e) => s + (e.count || 0), 0);
      const totalTargetContour = targetContours.reduce((s, e) => s + (e.count || 0), 0);
      const totalDoctorApproval = doctorApprovals.reduce((s, e) => s + (e.count || 0), 0);
      const totalReview = reviews.reduce((s, e) => s + (e.count || 0), 0);
      if ($('totalAdmission')) $('totalAdmission').textContent = String(totalAdmission);
      if ($('totalTargetContour')) $('totalTargetContour').textContent = String(totalTargetContour);
      if ($('totalDoctorApproval')) $('totalDoctorApproval').textContent = String(totalDoctorApproval);
      if ($('totalReview')) $('totalReview').textContent = String(totalReview);

      window.__summaryRows = buildSummaryRows(admissions, targetContours, doctorApprovals, reviews, groupBy);
      if ($('summaryTableFirstHeader')) $('summaryTableFirstHeader').textContent = byCampus ? '院区' : '主管医生';
      renderTable();
    }

    // Tab切换逻辑：数据图显示第二个联动下拉和按日/按月；汇总表不显示
    function setView(view) {
      const chart = document.getElementById('viewChart');
      const table = document.getElementById('viewTable');
      const tabChart = document.getElementById('tabChart');
      const tabTable = document.getElementById('tabTable');
      const filterValueWrap = document.getElementById('filterValueWrap');
      const granularityWrap = document.getElementById('granularityWrap');

      const isChart = view === 'chart';
      chart.classList.toggle('hidden', !isChart);
      table.classList.toggle('hidden', isChart);
      tabChart.classList.toggle('active', isChart);
      tabTable.classList.toggle('active', !isChart);

      if (filterValueWrap) filterValueWrap.classList.toggle('hidden', !isChart);
      if (granularityWrap) granularityWrap.classList.toggle('hidden', !isChart);
      if (isChart) {
        updateFilterValueOptions();
        refreshChart();
      } else {
        // 汇总表页面默认查询条件：按主管医生
        const modeEl = $('filterMode');
        if (modeEl) modeEl.value = 'attending';
      }
      refreshSummary();
    }

    // 初始化（数据图默认显示，第二个下拉可见并联动）
    contouringPanelKeys.forEach((k) => updateContouringPanelTitle(k));
    updateFilterValueOptions();

    refreshChart();
    refreshSummary();
    renderContouringDetailTable();

    // 默认显示数据图视图
    setView('chart');
    
    // Tab点击事件
    document.getElementById('tabChart').addEventListener('click', () => setView('chart'));
    document.getElementById('tabTable').addEventListener('click', () => setView('table'));
    document.getElementById('btnExport').addEventListener('click', () => alert('原型占位：导出'));

    // 查询条件联动（日期范围、按日/按月、两级下拉）
    $('dateRange')?.addEventListener('change', () => {
      refreshChart();
      refreshSummary();
      renderContouringDetailTable();
    });
    $('dateRange')?.addEventListener('input', () => {
      refreshChart();
      refreshSummary();
      renderContouringDetailTable();
    });
    document.querySelectorAll('input[name="timeGranularity"]').forEach((radio) => {
      radio.addEventListener('change', () => {
        refreshChart();
        refreshSummary();
        renderContouringDetailTable();
      });
    });
    $('filterMode')?.addEventListener('change', () => {
      updateFilterValueOptions();
      refreshChart();
      refreshSummary();
      renderContouringDetailTable();
    });
    $('filterValue')?.addEventListener('change', () => {
      refreshChart();
      refreshSummary();
      renderContouringDetailTable();
    });

    // 三个面板按钮事件（设置/明细/下载）
    contouringPanelKeys.forEach((k) => {
      document.getElementById(`btnContouringSetting${k}`)?.addEventListener('click', () => {
        // 仅超级管理员有此配置权限（原型中直接显示）
        openContouringSetting(k);
      });
      document.getElementById(`btnContouringDetail${k}`)?.addEventListener('click', () => {
        const title = contouringPanelConfig[k]?.menuLabel || '靶区勾画';
        const modalTitle = document.querySelector('#detailModal .modal-title');
        if (modalTitle) modalTitle.textContent = `${title}明细`;
        openModal('detailModal');
      });
      document.getElementById(`btnContouringDownload${k}`)?.addEventListener('click', () => {
        const title = contouringPanelConfig[k]?.menuLabel || '靶区勾画';
        const now = new Date();
        const dateStr = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
        alert(`原型占位：下载PNG格式图表 - 文件名：${title}统计${dateStr}.png`);
      });
    });
    document.getElementById('btnExportDetail').addEventListener('click', () => {
      const now = new Date();
      const dateStr = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
      const title = contouringPanelConfig[activeContouringPanelKey]?.menuLabel || '靶区勾画';
      alert(`原型占位：导出到XLS - 文件名：${title}明细${dateStr}.xls`);
    });

    // 点击遮罩层关闭弹窗
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('show');
        }
      });
    });
  </script>
</body>
</html>
