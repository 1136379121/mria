<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>加速器工作量统计 - 统计分析</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:#f5f5f5;
      color:#1f1f1f;
      padding:0;
      overflow:hidden;
    }
    :root{
      --primary:#1677ff;
      --border:#f0f0f0;
      --card:#fff;
      --muted:#8c8c8c;
      --shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .page{
      height: 100vh;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .header{
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: 0;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex: 0 0 auto;
    }
    .title{
      font-size: 18px;
      font-weight: 700;
      color:#333;
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 0;
    }
    .tabs{
      display:flex;
      align-items:center;
      gap: 16px;
    }
    .tab{
      font-size: 13px;
      color:#666;
      padding: 6px 0;
      cursor:pointer;
      border-bottom: 2px solid transparent;
      user-select:none;
    }
    .tab.active{
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 700;
    }
    .hidden{ display:none !important; }
    .filters{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .select, .input{
      height: 32px;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      padding: 0 10px;
      font-size: 13px;
      outline:none;
      background:#fff;
      color:#333;
    }
    .select{ min-width: 120px; }
    .input{ width: 260px; }
    .select:focus, .input:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(22,119,255,.18);
    }
    .btn{
      height: 32px;
      padding: 0 12px;
      border-radius: 6px;
      border: 1px solid #d9d9d9;
      background:#fff;
      cursor:pointer;
      font-size: 13px;
      color:#333;
      user-select:none;
      transition: all .15s ease;
    }
    .btn:hover{ border-color: var(--primary); color: var(--primary); }
    .btn.sm{
      height: 24px;
      padding: 0 10px;
      font-size: 11px;
      border-radius: 6px;
    }
    .seg{
      display:flex;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      overflow:hidden;
      height: 32px;
      background:#fff;
    }
    .seg button{
      border: none;
      background: transparent;
      padding: 0 12px;
      height: 32px;
      font-size: 13px;
      cursor:pointer;
      color:#666;
    }
    .seg button.active{
      background: #e6f4ff;
      color: var(--primary);
      font-weight: 700;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: 4px;
      font-size: 12px;
      line-height: 1;
      font-weight: 800;
      border: 1px solid transparent;
    }
    .badge.blue{ background:#e6f4ff; color: var(--primary); border-color:#bae0ff; }
    .content{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      padding: 0 10px 10px 10px;
    }
    .card{
      background: var(--card);
      border-radius: 0;
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: 0;
    }

    .panel-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      padding: 10px;
    }
    @media (max-width: 1100px){
      .panel-grid{ grid-template-columns: 1fr; }
    }
    .panel{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow:hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }
    .panel-hd{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#fff;
    }
    .panel-title{
      font-size: 13px;
      font-weight: 800;
      color:#333;
    }
    .panel-actions{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .panel-actions .inline-filters{
      display:flex;
      align-items:center;
      gap: 8px;
      margin-right: 4px;
    }
    .chart-wrap{ padding: 10px 12px 8px 12px; }
    .chart-box{
      height: 200px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background:#fff;
      /* 图例独占一行，绘图区在其下方 */
      padding: 8px 10px 10px 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      overflow:hidden;
    }
    .legend{
      position: static;
      width: 100%;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      font-size: 11px;
      color:#666;
      justify-content: flex-end;
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      max-width: none;
    }
    .legend-item{ display:flex; align-items:center; gap: 6px; }
    .legend-dot{ width: 10px; height: 10px; border-radius: 2px; }
    .plot-area{
      position: relative;
      flex: 1 1 auto;
      min-height: 0;
      padding: 14px 10px 30px 48px;
      overflow:hidden;
    }
    .y-axis{
      position:absolute;
      left: 0;
      top: 12px;
      bottom: 24px;
      width: 42px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      font-size: 11px;
      color:#999;
      text-align:right;
      padding-right: 8px;
      pointer-events:none;
    }
    .bars{
      height: 100%;
      display:flex;
      align-items:flex-end;
      justify-content:space-around;
      gap: 10px;
    }
    .bar-group{
      flex: 1;
      max-width: 120px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
    }
    .bar-stack{
      width: 44px;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      border-radius: 2px 2px 0 0;
      overflow:hidden;
      min-height: 2px;
    }
    .seg-bar{
      width: 100%;
    }
    .bar-total{
      position:absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      font-weight: 800;
      color:#333;
      white-space: nowrap;
      z-index: 2;
    }
    .bar-label{
      font-size: 11px;
      color:#666;
      white-space: nowrap;
    }

    .table-wrap{
      border-top: 1px solid var(--border);
      background:#fff;
      overflow:auto;
    }
    table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 720px;
    }
    thead th{
      background:#fafafa;
      color:#333;
      font-weight: 700;
      font-size: 12px;
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      text-align:center;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody td{
      font-size: 12px;
      color:#333;
      padding: 10px 8px;
      border-bottom: 1px solid #f5f5f5;
      text-align:center;
      white-space: nowrap;
    }
    tbody tr:hover{ background:#fafcff; }
    .col-left{
      text-align:left !important;
      padding-left: 12px !important;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 0 8px;
      height: 20px;
      border-radius: 999px;
      background:#e6f4ff;
      color: var(--primary);
      font-size: 12px;
      font-weight: 700;
    }
    .tag.gray{ background:#f5f5f5; color:#666; }
    .tag.blue{ background:#e6f4ff; color: var(--primary); }
    .tag.green{ background:#f6ffed; color:#389e0d; }
    .tag.orange{ background:#fff7e6; color:#d46b08; }
    .tag.red{ background:#fff1f0; color:#cf1322; }
    .tag.purple{ background:#f9f0ff; color:#722ed1; }

    .line-box{
      height: 200px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background:#fff;
      position: relative;
      padding: 10px 10px 10px 10px;
      overflow:hidden;
    }
    .line-legend{
      position:absolute;
      top: 8px;
      right: 10px;
      display:flex;
      align-items:center;
      gap: 6px;
      font-size: 11px;
      color:#666;
      background: rgba(255,255,255,.9);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 8px;
    }
    .line-legend .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background:#5470C6;
    }
    .line-svg{ width: 100%; height: 100%; }

    /* 汇总表 */
    .summary-wrap{
      padding: 10px;
    }
    .summary-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    @media (max-width: 1100px){
      .summary-grid{ grid-template-columns: 1fr; }
    }
    .summary-card{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow:hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
      min-height: 210px;
    }
    .summary-hd{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 800;
      color:#333;
    }
    .summary-bd{
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 18px;
      min-height: 160px;
    }
    .donut{
      width: 140px;
      height: 140px;
      border-radius: 999px;
      position: relative;
      background: conic-gradient(#5470C6 0 360deg);
      flex: 0 0 auto;
    }
    .donut::after{
      content:"";
      position:absolute;
      inset: 24px;
      background:#fff;
      border-radius: 999px;
      border: 1px solid var(--border);
    }
    .donut-center{
      position:absolute;
      inset: 0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index: 1;
      gap: 2px;
    }
    .donut-center .n{
      font-size: 20px;
      font-weight: 900;
      color:#333;
      line-height: 1;
    }
    .donut-center .t{
      font-size: 12px;
      font-weight: 700;
      color:#666;
    }
    .legend-list{
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width: 210px;
      max-width: 260px;
    }
    .legend-row{
      display:flex;
      align-items:center;
      gap: 8px;
      font-size: 12px;
      color:#333;
      white-space: nowrap;
    }
    .legend-row .dot{
      width: 10px;
      height: 10px;
      border-radius: 2px;
      flex: 0 0 auto;
    }
    .legend-row .name{
      flex: 1 1 auto;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .legend-row .meta{
      color:#666;
      font-variant-numeric: tabular-nums;
    }
    .summary-table{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow:hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }
    .summary-table-hd{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .summary-table-hd .t{
      font-size: 13px;
      font-weight: 800;
      color:#333;
    }
    .summary-table .table-wrap{
      border-top: none;
    }
    .summary-table table{ min-width: 980px; }
    .group-th{
      background:#fafafa;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 800;
      color:#333;
      padding: 10px 8px;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <div class="title">
        <span>加速器工作量统计</span>
        <div class="tabs" role="tablist" aria-label="视图切换">
          <div class="tab active" id="tabChart">数据图</div>
          <div class="tab" id="tabTable">汇总表</div>
        </div>
      </div>
      <div class="filters">
        <span id="filterMachine">
          <select class="select" id="machineSelect">
            <option selected>全部</option>
            <option>加速器A</option>
            <option>加速器B</option>
          </select>
        </span>
        <span id="filterCampus">
          <select class="select" id="campusSelect" title="院区">
            <option value="all" selected>全部院区</option>
            <option value="c1">本部院区</option>
            <option value="c2">东院区</option>
          </select>
        </span>
        <span id="filterDept">
          <select class="select" id="deptSelect">
            <option value="all" selected>全部科室</option>
            <option>放疗科</option>
            <option>肿瘤科</option>
          </select>
        </span>
        <input class="input" id="dateRange" value="2025-07-01 至 2026-01-31" />
        <span id="filterGranularity">
          <div class="seg" role="group" aria-label="时间粒度">
            <button type="button" id="btnDay">按日</button>
            <button type="button" id="btnMonth" class="active">按月</button>
          </div>
        </span>
      </div>
    </div>

    <div class="content">
      <!-- 视图1：数据图 -->
      <div class="card" id="viewChart">
        <div class="panel-grid">
          <!-- 预约统计 -->
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-title">预约统计</div>
              <div class="panel-actions">
                <button class="btn sm" data-action="detail" data-panel="booking">明细</button>
                <button class="btn sm" data-action="download" data-panel="booking">下载</button>
              </div>
            </div>
            <div class="chart-wrap">
              <div class="chart-box" id="chartBooking" aria-label="预约统计柱状图">
                <div class="legend" id="legendBooking"></div>
                <div class="plot-area">
                  <div class="y-axis" id="yAxisBooking"></div>
                  <div class="bars" id="barsBooking"></div>
                </div>
              </div>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="col-left" style="width: 120px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="tbodyBooking"></tbody>
              </table>
            </div>
          </div>

          <!-- 执行技术统计 -->
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-title">执行技术统计</div>
              <div class="panel-actions">
                <button class="btn sm" data-action="detail" data-panel="tech">明细</button>
                <button class="btn sm" data-action="download" data-panel="tech">下载</button>
              </div>
            </div>
            <div class="chart-wrap">
              <div class="chart-box" id="chartTech" aria-label="执行技术统计柱状图">
                <div class="legend" id="legendTech"></div>
                <div class="plot-area">
                  <div class="y-axis" id="yAxisTech"></div>
                  <div class="bars" id="barsTech"></div>
                </div>
              </div>
            </div>
            <div class="table-wrap" style="max-height: 188px;">
              <table style="min-width: 840px;">
                <thead>
                  <tr>
                    <th class="col-left" style="width: 140px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="tbodyTech"></tbody>
              </table>
            </div>
          </div>

          <!-- 拍片统计 -->
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-title">拍片统计</div>
              <div class="panel-actions">
                <button class="btn sm" data-action="detail" data-panel="imaging">明细</button>
                <button class="btn sm" data-action="download" data-panel="imaging">下载</button>
              </div>
            </div>
            <div class="chart-wrap">
              <div class="chart-box" id="chartImaging" aria-label="拍片统计柱状图">
                <div class="legend" id="legendImaging"></div>
                <div class="plot-area">
                  <div class="y-axis" id="yAxisImaging"></div>
                  <div class="bars" id="barsImaging"></div>
                </div>
              </div>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="col-left" style="width: 120px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="tbodyImaging"></tbody>
              </table>
            </div>
          </div>

          <!-- 治疗执行统计 -->
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-title">治疗执行统计</div>
              <div class="panel-actions">
                <div class="inline-filters">
                  <select class="select" id="execScopeSelect" style="min-width: 110px; height: 24px; font-size: 11px;">
                    <option selected>全部执行</option>
                    <option>计划执行</option>
                    <option>复位执行</option>
                  </select>
                  <select class="select" id="execMetricSelect" style="min-width: 110px; height: 24px; font-size: 11px;">
                    <option selected>技师分次次数</option>
                    <option>患者人次</option>
                  </select>
                </div>
                <button class="btn sm" data-action="detail" data-panel="execute">明细</button>
                <button class="btn sm" data-action="download" data-panel="execute">下载</button>
              </div>
            </div>
            <div class="chart-wrap">
              <div class="chart-box" id="chartExecute" aria-label="治疗执行统计柱状图">
                <div class="legend" id="legendExecute"></div>
                <div class="plot-area">
                  <div class="y-axis" id="yAxisExecute"></div>
                  <div class="bars" id="barsExecute"></div>
                </div>
              </div>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="col-left" style="width: 120px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="tbodyExecute"></tbody>
              </table>
            </div>
          </div>

          <!-- 工作负荷统计（单列，不跨两列以贴近截图） -->
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-title">工作负荷统计</div>
              <div class="panel-actions">
                <button class="btn sm" data-action="export" data-panel="workload">导出</button>
              </div>
            </div>
            <div class="chart-wrap">
              <div class="line-box" aria-label="工作负荷统计折线图">
                <div class="line-legend"><span class="dot"></span><span>完成人次</span></div>
                <svg class="line-svg" id="svgWorkload" viewBox="0 0 720 200" preserveAspectRatio="none"></svg>
              </div>
            </div>
            <div class="table-wrap">
              <table style="min-width: 760px;">
                <thead>
                  <tr>
                    <th class="col-left" style="width: 120px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="tbodyWorkload"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 视图2：汇总表（内容后续补充，先置空） -->
      <div class="card hidden" id="viewTable">
        <div class="summary-wrap">
          <div class="summary-grid">
            <div class="summary-card">
              <div class="summary-hd">执行技术统计</div>
              <div class="summary-bd">
                <div class="donut" id="donutTech">
                  <div class="donut-center">
                    <div class="n" id="donutTechTotal">64</div>
                    <div class="t">总数</div>
                  </div>
                </div>
                <div class="legend-list" id="legendTechSummary"></div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-hd">拍片统计</div>
              <div class="summary-bd">
                <div class="donut" id="donutImaging">
                  <div class="donut-center">
                    <div class="n" id="donutImagingTotal">17</div>
                    <div class="t">总数</div>
                  </div>
                </div>
                <div class="legend-list" id="legendImagingSummary"></div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-hd">执行次数统计</div>
              <div class="summary-bd">
                <div class="donut" id="donutExec">
                  <div class="donut-center">
                    <div class="n" id="donutExecTotal">54</div>
                    <div class="t">总数</div>
                  </div>
                </div>
                <div class="legend-list" id="legendExecSummary"></div>
              </div>
            </div>
          </div>

          <div class="summary-table">
            <div class="summary-table-hd">
              <div class="t">汇总表</div>
              <button class="btn sm" data-action="export" data-panel="summary">导出</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="group-th" rowspan="2" style="width: 160px; text-align:left; padding-left:12px;">机房名称</th>
                    <th class="group-th" colspan="6">执行技术统计</th>
                    <th class="group-th" colspan="4">拍片统计</th>
                    <th class="group-th" colspan="1">执行次数统计</th>
                  </tr>
                  <tr>
                    <th>SRS</th><th>未知</th><th>常规</th><th>SBRT</th><th>ABC</th><th>合计</th>
                    <th>EPID</th><th>否</th><th>CBCT</th><th>合计</th>
                    <th>合计</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="col-left">治疗室1-射线照</td>
                    <td>13</td><td>24</td><td>2</td><td>12</td><td>2</td><td><span class="badge blue">53</span></td>
                    <td>7</td><td>0</td><td>8</td><td><span class="badge blue">15</span></td>
                    <td><span class="badge blue">43</span></td>
                  </tr>
                  <tr>
                    <td class="col-left">治疗室3</td>
                    <td>0</td><td>9</td><td>0</td><td>0</td><td>0</td><td><span class="badge blue">9</span></td>
                    <td>0</td><td>0</td><td>0</td><td><span class="badge blue">0</span></td>
                    <td><span class="badge blue">9</span></td>
                  </tr>
                  <tr>
                    <td class="col-left">mosaic机房</td>
                    <td>1</td><td>0</td><td>0</td><td>1</td><td>0</td><td><span class="badge blue">2</span></td>
                    <td>0</td><td>2</td><td>0</td><td><span class="badge blue">2</span></td>
                    <td><span class="badge blue">2</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const months = ['2025-07','2025-08','2025-09','2025-10','2025-11','2025-12','2026-01'];

    function setGranularity(type){
      const btnDay = document.getElementById('btnDay');
      const btnMonth = document.getElementById('btnMonth');
      const isMonth = type === 'month';
      btnDay?.classList.toggle('active', !isMonth);
      btnMonth?.classList.toggle('active', isMonth);
      // 原型：按日/按月仅切换样式
    }

    function renderLegend(containerId, series){
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = series.map(s => `
        <span class="legend-item">
          <span class="legend-dot" style="background:${s.color}"></span>
          <span>${s.name}</span>
        </span>
      `).join('');
    }

    function renderYAxis(containerId, maxValue){
      const el = document.getElementById(containerId);
      if (!el) return;
      const max = Math.max(maxValue, 1);
      const ticks = max <= 1 ? [1,0] : [max, Math.floor(max/2), 0];
      el.innerHTML = ticks.map(t => `<div>${t}</div>`).join('');
    }

    function renderStackedBars({ barsId, yAxisId, legendId, data, series }){
      // data: [{x, values:{seriesName:number}}]
      const barsEl = document.getElementById(barsId);
      if (!barsEl) return;
      renderLegend(legendId, series);
      const totals = data.map(d => series.reduce((sum, s) => sum + (d.values[s.name] || 0), 0));
      const max = Math.max(...totals, 1);
      renderYAxis(yAxisId, max);

      barsEl.innerHTML = '';
      data.forEach((d, idx) => {
        const total = totals[idx];
        const group = document.createElement('div');
        group.className = 'bar-group';

        const stackWrap = document.createElement('div');
        stackWrap.className = 'bar-stack';
        stackWrap.style.height = ((total / max) * 140 + 6) + 'px';
        stackWrap.style.position = 'relative';
        if (total > 0) {
          const t = document.createElement('div');
          t.className = 'bar-total';
          t.textContent = total;
          stackWrap.appendChild(t);
        }
        // bottom -> top
        series.forEach(s => {
          const v = d.values[s.name] || 0;
          if (v <= 0) return;
          const seg = document.createElement('div');
          seg.className = 'seg-bar';
          seg.style.height = (v / total) * 100 + '%';
          seg.style.background = s.color;
          stackWrap.appendChild(seg);
        });

        const label = document.createElement('div');
        label.className = 'bar-label';
        label.textContent = d.x;

        group.appendChild(stackWrap);
        group.appendChild(label);
        barsEl.appendChild(group);
      });
    }

    function renderSimpleBars({ barsId, yAxisId, legendId, data, color, name }){
      const barsEl = document.getElementById(barsId);
      if (!barsEl) return;
      renderLegend(legendId, [{name, color}]);
      const max = Math.max(...data.map(d => d.v), 1);
      renderYAxis(yAxisId, max);

      barsEl.innerHTML = '';
      data.forEach(d => {
        const group = document.createElement('div');
        group.className = 'bar-group';

        const stackWrap = document.createElement('div');
        stackWrap.className = 'bar-stack';
        stackWrap.style.height = ((d.v / max) * 140 + 6) + 'px';
        stackWrap.style.position = 'relative';
        stackWrap.style.background = 'transparent';
        stackWrap.style.borderRadius = '2px 2px 0 0';
        stackWrap.style.overflow = 'hidden';
        if (d.v > 0) {
          const t = document.createElement('div');
          t.className = 'bar-total';
          t.textContent = d.v;
          stackWrap.appendChild(t);
        }
        const seg = document.createElement('div');
        seg.className = 'seg-bar';
        seg.style.height = '100%';
        seg.style.background = color;
        stackWrap.appendChild(seg);

        const label = document.createElement('div');
        label.className = 'bar-label';
        label.textContent = d.x;

        group.appendChild(stackWrap);
        group.appendChild(label);
        barsEl.appendChild(group);
      });
    }

    function renderTableRows(tbodyId, rows){
      const el = document.getElementById(tbodyId);
      if (!el) return;
      el.innerHTML = rows.map(r => {
        const cells = months.map(m => `<td>${r.data[m] ?? 0}</td>`).join('');
        return `<tr><td class="col-left">${r.labelHtml}</td>${cells}</tr>`;
      }).join('');
    }

    function renderWorkloadTable(){
      const el = document.getElementById('tbodyWorkload');
      if (!el) return;
      const rows = [
        { labelHtml: `<span class="tag blue">开始时间</span>`, data: {'2025-07':'00:00','2025-08':'00:00','2025-09':'00:49','2025-10':'11:06','2025-11':'00:00','2025-12':'14:14','2026-01':'10:33'} },
        { labelHtml: `<span class="tag blue">结束时间</span>`, data: {'2025-07':'16:39','2025-08':'18:48','2025-09':'18:43','2025-10':'17:12','2025-11':'22:47','2025-12':'15:48','2026-01':'10:43'} },
        { labelHtml: `<span class="tag blue">患者人次</span>`, data: {'2025-07':56,'2025-08':99,'2025-09':20,'2025-10':5,'2025-11':18,'2025-12':13,'2026-01':220} },
        { labelHtml: `<span class="tag blue">完成人次</span>`, data: {'2025-07':11,'2025-08':2,'2025-09':9,'2025-10':10,'2025-11':14,'2025-12':2,'2026-01':3} }
      ];
      el.innerHTML = rows.map(r => {
        const cells = months.map(m => `<td>${r.data[m] ?? ''}</td>`).join('');
        return `<tr><td class="col-left">${r.labelHtml}</td>${cells}</tr>`;
      }).join('');
    }

    function renderWorkloadLine(){
      const svg = document.getElementById('svgWorkload');
      if (!svg) return;
      const values = [11,2,9,10,14,2,3]; // 完成人次
      const max = Math.max(...values, 1);
      const w = 720, h = 200;
      const padL = 36, padR = 12, padT = 18, padB = 28;
      const innerW = w - padL - padR;
      const innerH = h - padT - padB;
      const pts = values.map((v, i) => {
        const x = padL + (innerW * (i / (values.length - 1)));
        const y = padT + innerH * (1 - (v / max));
        return {x, y};
      });
      const d = pts.map((p, i) => `${i===0?'M':'L'} ${p.x.toFixed(1)} ${p.y.toFixed(1)}`).join(' ');
      const gridLines = 4;
      const grid = Array.from({length: gridLines+1}).map((_, i) => {
        const y = padT + innerH * (i / gridLines);
        return `<line x1="${padL}" y1="${y}" x2="${w-padR}" y2="${y}" stroke="#f0f0f0" stroke-width="1" />`;
      }).join('');
      const circles = pts.map(p => `<circle cx="${p.x}" cy="${p.y}" r="3" fill="#5470C6" />`).join('');
      const labels = months.map((m, i) => {
        const x = padL + (innerW * (i / (months.length - 1)));
        return `<text x="${x}" y="${h-10}" font-size="10" fill="#999" text-anchor="middle">${m}</text>`;
      }).join('');
      svg.innerHTML = `
        ${grid}
        <path d="${d}" fill="none" stroke="#5470C6" stroke-width="2" />
        ${circles}
        ${labels}
      `;
    }

    function initDataChart(){
      // 预约统计（已完成/未完成）
      const bookingSeries = [
        { name: '已完成', color: '#4E79A7' },
        { name: '未完成', color: '#8BC34A' }
      ];
      const booking = months.map((m, idx) => ({
        x: m,
        values: {
          '已完成': [11,2,9,10,14,2,3][idx],
          '未完成': [56,99,20,5,18,13,220][idx]
        }
      }));
      renderStackedBars({
        barsId: 'barsBooking',
        yAxisId: 'yAxisBooking',
        legendId: 'legendBooking',
        data: booking,
        series: bookingSeries
      });
      renderTableRows('tbodyBooking', [
        { labelHtml: `<span class="tag blue">已完成</span>`, data: {'2025-07':11,'2025-08':2,'2025-09':9,'2025-10':10,'2025-11':14,'2025-12':2,'2026-01':3} },
        { labelHtml: `<span class="tag green">未完成</span>`, data: {'2025-07':56,'2025-08':99,'2025-09':20,'2025-10':5,'2025-11':18,'2025-12':13,'2026-01':220} },
        { labelHtml: `<span class="tag gray">总计</span>`, data: {'2025-07':67,'2025-08':101,'2025-09':29,'2025-10':15,'2025-11':32,'2025-12':15,'2026-01':223} }
      ]);

      // 执行技术统计（SRS/术中/常规/SBRT/ABC）
      const techSeries = [
        { name: 'SRS', color: '#5B8FF9' },
        { name: '术中', color: '#73C0DE' },
        { name: '常规', color: '#91CC75' },
        { name: 'SBRT', color: '#FAC858' },
        { name: 'ABC', color: '#EE6666' }
      ];
      const techData = months.map((m, idx) => ({
        x: m,
        values: {
          'SRS': [2,1,6,2,2,1,0][idx],
          '术中': [0,0,0,0,0,0,0][idx],
          '常规': [6,6,3,5,11,1,3][idx],
          'SBRT': [0,2,6,2,2,1,0][idx],
          'ABC': [0,1,0,0,1,0,0][idx]
        }
      }));
      renderStackedBars({
        barsId: 'barsTech',
        yAxisId: 'yAxisTech',
        legendId: 'legendTech',
        data: techData,
        series: techSeries
      });
      renderTableRows('tbodyTech', [
        { labelHtml: `<span class="tag blue">SRS</span>`, data: {'2025-07':2,'2025-08':1,'2025-09':6,'2025-10':2,'2025-11':2,'2025-12':1,'2026-01':0} },
        { labelHtml: `<span class="tag gray">术中</span>`, data: {'2025-07':0,'2025-08':0,'2025-09':0,'2025-10':0,'2025-11':0,'2025-12':0,'2026-01':0} },
        { labelHtml: `<span class="tag green">常规</span>`, data: {'2025-07':6,'2025-08':6,'2025-09':3,'2025-10':5,'2025-11':11,'2025-12':1,'2026-01':3} },
        { labelHtml: `<span class="tag orange">SBRT</span>`, data: {'2025-07':0,'2025-08':2,'2025-09':6,'2025-10':2,'2025-11':2,'2025-12':1,'2026-01':0} },
        { labelHtml: `<span class="tag red">ABC</span>`, data: {'2025-07':0,'2025-08':1,'2025-09':0,'2025-10':0,'2025-11':1,'2025-12':0,'2026-01':0} },
        { labelHtml: `<span class="tag gray">总计</span>`, data: {'2025-07':8,'2025-08':10,'2025-09':15,'2025-10':9,'2025-11':16,'2025-12':3,'2026-01':3} }
      ]);

      // 拍片统计（EPID/CBCT）
      const imagingSeries = [
        { name: 'EPID', color: '#5470C6' },
        { name: 'CBCT', color: '#FAC858' }
      ];
      const imagingData = months.map((m, idx) => ({
        x: m,
        values: {
          'EPID': [0,0,0,0,3,1,3][idx],
          'CBCT': [1,1,3,3,0,2,0][idx]
        }
      }));
      renderStackedBars({
        barsId: 'barsImaging',
        yAxisId: 'yAxisImaging',
        legendId: 'legendImaging',
        data: imagingData,
        series: imagingSeries
      });
      renderTableRows('tbodyImaging', [
        { labelHtml: `<span class="tag blue">EPID</span>`, data: {'2025-07':0,'2025-08':0,'2025-09':0,'2025-10':0,'2025-11':3,'2025-12':1,'2026-01':3} },
        { labelHtml: `<span class="tag orange">CBCT</span>`, data: {'2025-07':1,'2025-08':1,'2025-09':3,'2025-10':3,'2025-11':0,'2025-12':2,'2026-01':0} },
        { labelHtml: `<span class="tag gray">总计</span>`, data: {'2025-07':1,'2025-08':1,'2025-09':3,'2025-10':3,'2025-11':3,'2025-12':3,'2026-01':3} }
      ]);

      // 治疗执行统计（技师分次次数）
      const exec = months.map((m, idx) => ({ x: m, v: [8,8,9,8,15,3,3][idx] }));
      renderSimpleBars({
        barsId: 'barsExecute',
        yAxisId: 'yAxisExecute',
        legendId: 'legendExecute',
        data: exec,
        color: '#5470C6',
        name: ''
      });
      renderTableRows('tbodyExecute', [
        { labelHtml: `<span class="tag gray">总计</span>`, data: {'2025-07':8,'2025-08':8,'2025-09':9,'2025-10':8,'2025-11':15,'2025-12':3,'2026-01':3} }
      ]);

      // 工作负荷统计（折线 + 表格）
      renderWorkloadLine();
      renderWorkloadTable();
    }

    function renderDonut(elId, legendId, totalElId, items){
      // items: [{name, value, color}]
      const donut = document.getElementById(elId);
      const legend = document.getElementById(legendId);
      const totalEl = document.getElementById(totalElId);
      if (!donut || !legend || !totalEl) return;
      const total = items.reduce((s, it) => s + it.value, 0) || 1;
      totalEl.textContent = total;

      // conic-gradient
      let acc = 0;
      const parts = items.map(it => {
        const start = acc;
        const pct = (it.value / total) * 100;
        acc += pct;
        return `${it.color} ${start.toFixed(4)}% ${acc.toFixed(4)}%`;
      });
      donut.style.background = `conic-gradient(${parts.join(',')})`;

      legend.innerHTML = items.map(it => {
        const pct = ((it.value / total) * 100);
        return `
          <div class="legend-row">
            <span class="dot" style="background:${it.color}"></span>
            <span class="name">${it.name}</span>
            <span class="meta">${it.value}</span>
            <span class="meta">${pct.toFixed(2)}%</span>
          </div>
        `;
      }).join('');
    }

    function initSummary(){
      // 参考UI：图例按机房汇总
      renderDonut('donutTech', 'legendTechSummary', 'donutTechTotal', [
        { name: '治疗室1-射线照', value: 53, color: '#5470C6' },
        { name: '治疗室3', value: 9, color: '#91CC75' },
        { name: 'mosaic机房', value: 2, color: '#FAC858' }
      ]);
      renderDonut('donutImaging', 'legendImagingSummary', 'donutImagingTotal', [
        { name: '治疗室1-射线照', value: 15, color: '#5470C6' },
        { name: 'mosaic机房', value: 2, color: '#91CC75' }
      ]);
      renderDonut('donutExec', 'legendExecSummary', 'donutExecTotal', [
        { name: '治疗室1-射线照', value: 43, color: '#5470C6' },
        { name: '治疗室3', value: 9, color: '#91CC75' },
        { name: 'mosaic机房', value: 2, color: '#FAC858' }
      ]);
    }

    function setView(view) {
      const chart = document.getElementById('viewChart');
      const table = document.getElementById('viewTable');
      const tabChart = document.getElementById('tabChart');
      const tabTable = document.getElementById('tabTable');
      const filterMachine = document.getElementById('filterMachine');
      const filterCampus = document.getElementById('filterCampus');
      const filterDept = document.getElementById('filterDept');
      const filterGranularity = document.getElementById('filterGranularity');

      const isChart = view === 'chart';
      chart.classList.toggle('hidden', !isChart);
      table.classList.toggle('hidden', isChart);
      tabChart.classList.toggle('active', isChart);
      tabTable.classList.toggle('active', !isChart);

      // 汇总表截图中仅保留日期范围
      filterMachine?.classList.toggle('hidden', !isChart);
      // 本次调整：汇总表查询条件需要“院区/科室”，两视图均显示
      filterCampus?.classList.toggle('hidden', false);
      filterDept?.classList.toggle('hidden', false);
      filterGranularity?.classList.toggle('hidden', !isChart);
    }

    setView('chart');
    document.getElementById('tabChart').addEventListener('click', () => setView('chart'));
    document.getElementById('tabTable').addEventListener('click', () => setView('table'));

    initDataChart();
    initSummary();
    document.getElementById('btnDay')?.addEventListener('click', () => setGranularity('day'));
    document.getElementById('btnMonth')?.addEventListener('click', () => setGranularity('month'));
    document.body.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const act = btn.getAttribute('data-action');
      const panel = btn.getAttribute('data-panel');
      const map = {
        detail: '原型占位：明细',
        download: '原型占位：下载',
        export: '原型占位：导出'
      };
      alert(`${map[act] || '原型占位'}（${panel || ''}）`);
    });
  </script>
</body>
</html>

