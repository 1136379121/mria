<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç™»å½• - Mriaç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .hospital-logo {
            position: absolute;
            top: 20px;
            left: 20px;
            height: 60px;
            max-width: 200px;
            object-fit: contain;
        }

        /* ç™»å½•åŒºåŸŸæ•´ä½“ä¸Šç§»ï¼ˆç³»ç»Ÿæ ‡é¢˜ + è¾“å…¥æ¡†å®¹å™¨ï¼‰ */
        .login-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateY(-100px);
        }

        .login-container {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            padding: 40px;
            position: relative;
        }

        .system-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 55px;
            font-weight: 600;
            letter-spacing: 2px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
        }

        .error-message {
            background: #fff1f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .error-message.show {
            display: block;
        }

        .error-message.success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .input-wrapper {
            position: relative;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            transition: all 0.3s;
            outline: none;
        }

        .form-control:focus {
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .form-control.error {
            border-color: #ff4d4f;
        }

        .form-control.error:focus {
            border-color: #ff4d4f;
            box-shadow: 0 0 0 2px rgba(255, 77, 79, 0.2);
        }

        .form-control:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .error-text {
            color: #ff4d4f;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-text.show {
            display: block;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 18px;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .password-toggle:hover {
            color: #1890ff;
            background: #f0f7ff;
        }

        .captcha-group {
            display: none;
        }

        .captcha-group.show {
            display: block;
        }

        .captcha-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .captcha-wrapper .form-control {
            flex: 1;
        }

        .captcha-image {
            width: 120px;
            height: 40px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: #666;  
            user-select: none;
            transition: all 0.3s;
            position: relative;
        }

        .captcha-image:hover:not(.loading) {
            border-color: #1890ff;
            background: #f0f7ff;
        }

        .captcha-image.loading {
            cursor: wait;
        }

        .captcha-image.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid #1890ff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        .login-button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: 500;
            color: #fff;
            background: #1890ff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .login-button:hover:not(:disabled) {
            background: #40a9ff;
        }

        .login-button:active:not(:disabled) {
            background: #096dd9;
        }

        .login-button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }

        .login-button.loading {
            color: transparent;
        }

        .login-button.loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .account-locked {
            background: #fff7e6;
            border: 1px solid #ffd591;
            color: #d46b08;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .account-locked.show {
            display: block;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) and (min-width: 769px) {
            /* å¹³æ¿ç«¯ */
            .login-container {
                max-width: 350px;
            }
        }

        @media (max-width: 768px) {
            /* ç§»åŠ¨ç«¯ */
            .hospital-logo {
                top: 15px;
                left: 15px;
                height: 45px;
                max-width: 150px;
            }

            .login-container {
                padding: 30px 20px;
                max-width: 90%;
            }

            .system-title {
                font-size: 28px;
            }

            .form-control {
                font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
                padding: 14px 16px; /* åŠ å¤§é«˜åº¦ä¾¿äºè§¦æ‘¸ */
            }

            .login-button {
                padding: 14px;
            }
        }

        @media (max-width: 480px) {
            .captcha-wrapper {
                flex-direction: column;
            }

            .captcha-image {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <img src="../UIå›¾/åŒ»é™¢logo.png" alt="åŒ»é™¢Logo" class="hospital-logo">
    <div class="login-wrapper">
        <h1 class="system-title">æ”¾å°„æ²»ç–—ä¿¡æ¯ç®¡ç†è½¯ä»¶</h1>
        <div class="login-container">
            <div class="login-header">
                <p>æ¬¢è¿ç™»å½•</p>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="account-locked" id="accountLocked">
                <strong>è´¦å·å·²è¢«é”å®š</strong><br>
                <span id="lockedTime"></span> åˆ†é’Ÿåå¯ä»¥å†æ¬¡å°è¯•ç™»å½•
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="account">è´¦å·</label>
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="account" 
                            class="form-control" 
                            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                            autocomplete="username"
                            maxlength="50"
                        >
                    </div>
                    <div class="error-text" id="accountError"></div>
                </div>

                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <div class="input-wrapper">
                        <input 
                            type="password" 
                            id="password" 
                            class="form-control" 
                            placeholder="è¯·è¾“å…¥å¯†ç "
                            autocomplete="current-password"
                            maxlength="128"
                        >
                        <button type="button" class="password-toggle" id="passwordToggle" title="æ˜¾ç¤º/éšè—å¯†ç ">
                            ğŸ‘ï¸
                        </button>
                    </div>
                    <div class="error-text" id="passwordError"></div>
                </div>

                <div class="form-group captcha-group" id="captchaGroup">
                    <label for="captcha">éªŒè¯ç </label>
                    <div class="captcha-wrapper">
                        <input 
                            type="text" 
                            id="captcha" 
                            class="form-control" 
                            placeholder="è¯·è¾“å…¥éªŒè¯ç "
                            maxlength="6"
                            autocomplete="off"
                        >
                        <div class="captcha-image" id="captchaImage" title="ç‚¹å‡»åˆ·æ–°éªŒè¯ç ">
                            A3B2
                        </div>
                    </div>
                    <div class="error-text" id="captchaError"></div>
                </div>

                <button type="submit" class="login-button" id="loginButton" disabled>
                    ç™»å½•
                </button>
            </form>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let failedAttempts = 0;
        let isLocked = false;
        let lockUntil = null;
        let isPasswordVisible = false;
        let captchaId = null;

        // DOMå…ƒç´ 
        const loginForm = document.getElementById('loginForm');
        const accountInput = document.getElementById('account');
        const passwordInput = document.getElementById('password');
        const captchaInput = document.getElementById('captcha');
        const captchaGroup = document.getElementById('captchaGroup');
        const captchaImage = document.getElementById('captchaImage');
        const passwordToggle = document.getElementById('passwordToggle');
        const loginButton = document.getElementById('loginButton');
        const errorMessage = document.getElementById('errorMessage');
        const accountLocked = document.getElementById('accountLocked');
        const lockedTime = document.getElementById('lockedTime');
        const accountError = document.getElementById('accountError');
        const passwordError = document.getElementById('passwordError');
        const captchaError = document.getElementById('captchaError');

        // åˆå§‹åŒ–ï¼šæ£€æŸ¥é”å®šçŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            checkAccountLock();
        });

        // æ£€æŸ¥è´¦å·é”å®šçŠ¶æ€
        function checkAccountLock() {
            const lockTime = localStorage.getItem('lockUntil');
            if (lockTime) {
                const lockDate = new Date(lockTime);
                const now = new Date();
                if (lockDate > now) {
                    isLocked = true;
                    lockUntil = lockDate;
                    showAccountLocked(lockDate);
                } else {
                    localStorage.removeItem('lockUntil');
                    localStorage.removeItem('failedAttempts');
                    failedAttempts = 0;
                }
            } else {
                failedAttempts = parseInt(localStorage.getItem('failedAttempts') || '0');
                if (failedAttempts >= 3) {
                    showCaptcha();
                }
            }
        }

        // æ˜¾ç¤ºè´¦å·é”å®šæç¤º
        function showAccountLocked(lockDate) {
            const updateLockTime = () => {
                const now = new Date();
                const diff = lockDate - now;
                if (diff <= 0) {
                    isLocked = false;
                    accountLocked.classList.remove('show');
                    accountInput.disabled = false;
                    passwordInput.disabled = false;
                    localStorage.removeItem('lockUntil');
                    localStorage.removeItem('failedAttempts');
                    failedAttempts = 0;
                    updateLoginButtonState();
                    return;
                }
                const minutes = Math.ceil(diff / 1000 / 60);
                lockedTime.textContent = minutes;
                accountLocked.classList.add('show');
                
                // ç¦ç”¨è¡¨å•
                accountInput.disabled = true;
                passwordInput.disabled = true;
                loginButton.disabled = true;
                
                setTimeout(updateLockTime, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
            };
            updateLockTime();
        }

        // æ˜¾ç¤ºéªŒè¯ç 
        function showCaptcha() {
            captchaGroup.classList.add('show');
            generateCaptcha();
        }

        // ç”ŸæˆéªŒè¯ç ï¼ˆæ¨¡æ‹ŸAPIè°ƒç”¨ï¼‰
        function generateCaptcha() {
            // æ˜¾ç¤ºloadingçŠ¶æ€
            captchaImage.classList.add('loading');
            captchaImage.textContent = '';
            
            // æ¨¡æ‹ŸAPIè°ƒç”¨è·å–éªŒè¯ç 
            setTimeout(() => {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let result = '';
                for (let i = 0; i < 4; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                captchaId = 'captcha_' + Date.now();
                captchaImage.textContent = result;
                captchaImage.classList.remove('loading');
                // å­˜å‚¨éªŒè¯ç ç­”æ¡ˆï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥å­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼‰
                captchaImage.dataset.answer = result;
                captchaImage.dataset.captchaId = captchaId;
            }, 300);
        }

        // ç‚¹å‡»éªŒè¯ç åˆ·æ–°
        captchaImage.addEventListener('click', () => {
            if (!captchaImage.classList.contains('loading')) {
                generateCaptcha();
                captchaInput.value = '';
                clearError(captchaInput, captchaError);
            }
        });

        // å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢
        passwordToggle.addEventListener('click', () => {
            isPasswordVisible = !isPasswordVisible;
            passwordInput.type = isPasswordVisible ? 'text' : 'password';
            passwordToggle.textContent = isPasswordVisible ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
        });

        // è¾“å…¥æ¡†å®æ—¶éªŒè¯
        accountInput.addEventListener('blur', validateAccount);
        passwordInput.addEventListener('blur', validatePassword);
        captchaInput.addEventListener('blur', validateCaptcha);

        // è¾“å…¥æ—¶æ¸…é™¤é”™è¯¯çŠ¶æ€
        accountInput.addEventListener('input', () => {
            clearError(accountInput, accountError);
            updateLoginButtonState();
        });

        passwordInput.addEventListener('input', () => {
            clearError(passwordInput, passwordError);
            updateLoginButtonState();
        });

        captchaInput.addEventListener('input', () => {
            clearError(captchaInput, captchaError);
        });

        // å›è½¦é”®æäº¤ï¼ˆæ”¯æŒTabé”®åˆ‡æ¢ï¼‰
        accountInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !loginButton.disabled) {
                passwordInput.focus();
            }
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !loginButton.disabled) {
                if (captchaGroup.classList.contains('show')) {
                    captchaInput.focus();
                } else {
                    loginForm.dispatchEvent(new Event('submit'));
                }
            }
        });

        captchaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !loginButton.disabled) {
                loginForm.dispatchEvent(new Event('submit'));
            }
        });

        // æ›´æ–°ç™»å½•æŒ‰é’®çŠ¶æ€
        function updateLoginButtonState() {
            const account = accountInput.value.trim();
            const password = passwordInput.value.trim();
            const shouldEnable = account && password && !isLocked;
            loginButton.disabled = !shouldEnable;
        }

        // éªŒè¯è´¦å·æ ¼å¼
        function validateAccount() {
            const account = accountInput.value.trim();
            if (!account) {
                showError(accountInput, accountError, 'è¯·è¾“å…¥ç”¨æˆ·å');
                return false;
            }

            if (account.length > 50) {
                showError(accountInput, accountError, 'ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦');
                return false;
            }

            // ç”¨æˆ·åæ ¼å¼éªŒè¯ï¼š1-50å­—ç¬¦ï¼Œæ”¯æŒå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
            const usernameRegex = /^[a-zA-Z0-9_]{1,50}$/;
            
            if (usernameRegex.test(account)) {
                // ç”¨æˆ·åæ ¼å¼æ­£ç¡®
                clearError(accountInput, accountError);
                return true;
            } else {
                showError(accountInput, accountError, 'ç”¨æˆ·åæ ¼å¼ä¸æ­£ç¡®ï¼ˆæ”¯æŒå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰');
                return false;
            }
        }

        // éªŒè¯å¯†ç æ ¼å¼
        function validatePassword() {
            const password = passwordInput.value;
            if (!password) {
                showError(passwordInput, passwordError, 'è¯·è¾“å…¥å¯†ç ');
                return false;
            }

            if (password.length < 8) {
                showError(passwordInput, passwordError, 'å¯†ç é•¿åº¦è‡³å°‘8ä½');
                return false;
            }

            if (password.length > 128) {
                showError(passwordInput, passwordError, 'å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡128ä½');
                return false;
            }

            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            
            if (!hasLetter || !hasNumber) {
                showError(passwordInput, passwordError, 'å¯†ç éœ€åŒ…å«å­—æ¯å’Œæ•°å­—');
                return false;
            }

            clearError(passwordInput, passwordError);
            return true;
        }

        // éªŒè¯éªŒè¯ç 
        function validateCaptcha() {
            if (!captchaGroup.classList.contains('show')) {
                return true;
            }

            const captcha = captchaInput.value.trim().toUpperCase();
            if (!captcha) {
                showError(captchaInput, captchaError, 'è¯·è¾“å…¥éªŒè¯ç ');
                return false;
            }

            if (captcha.length < 4 || captcha.length > 6) {
                showError(captchaInput, captchaError, 'éªŒè¯ç é•¿åº¦ä¸º4-6ä½');
                return false;
            }

            if (captcha !== captchaImage.dataset.answer) {
                showError(captchaInput, captchaError, 'éªŒè¯ç é”™è¯¯');
                return false;
            }

            clearError(captchaInput, captchaError);
            return true;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(input, errorElement, message) {
            input.classList.add('error');
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }

        // æ¸…é™¤é”™è¯¯
        function clearError(input, errorElement) {
            input.classList.remove('error');
            errorElement.classList.remove('show');
        }

        // æ˜¾ç¤ºå…¨å±€é”™è¯¯æ¶ˆæ¯
        function showErrorMessage(message) {
            errorMessage.classList.remove('success');
            errorMessage.style.background = '#fff1f0';
            errorMessage.style.borderColor = '#ffccc7';
            errorMessage.style.color = '#ff4d4f';
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 3000);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            errorMessage.classList.add('success');
            errorMessage.style.background = '#f6ffed';
            errorMessage.style.borderColor = '#b7eb8f';
            errorMessage.style.color = '#52c41a';
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 3000);
        }

        // å¯†ç åŠ å¯†ï¼ˆMD5æ¨¡æ‹Ÿï¼‰
        function md5Hash(text) {
            // å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨ crypto-js ç­‰åº“
            // è¿™é‡Œä»…ä½œæ¼”ç¤ºï¼Œè¿”å›ç®€å•å“ˆå¸Œ
            return btoa(text).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
        }

        // æ¨¡æ‹Ÿç™»å½•APIè°ƒç”¨
        async function login(account, password, captcha) {
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 500));

            // æ¨¡æ‹ŸéªŒè¯ç éªŒè¯
            if (captchaGroup.classList.contains('show')) {
                if (!captcha || captcha.toUpperCase() !== captchaImage.dataset.answer) {
                    throw { code: 400, message: 'éªŒè¯ç é”™è¯¯' };
                }
            }

            // æ¨¡æ‹Ÿè´¦å·å¯†ç éªŒè¯
            // è¶…çº§ç®¡ç†å‘˜è´¦å·ï¼šmpadminï¼Œå¯†ç ï¼šadmin123
            // æµ‹è¯•è´¦å·ï¼šuser123ï¼Œå¯†ç ï¼šTest1234
            const superAdminAccount = 'mpadmin';
            const superAdminPassword = 'admin123';
            const testAccount = 'user123';
            const testPassword = 'Test1234';

            if (account === superAdminAccount && password === superAdminPassword) {
                return {
                    code: 200,
                    message: 'ç™»å½•æˆåŠŸ',
                    data: {
                        token: 'mock_token_' + Date.now(),
                        refreshToken: 'refresh_token_' + Date.now(),
                        userId: 'admin001',
                        username: 'mpadmin',
                        avatar: '',
                        role: 'admin',
                        permissions: ['admin', 'menu_management', 'doctor', 'nurse', 'technician', 'physicist'],
                        expiresIn: 86400 // 24å°æ—¶
                    }
                };
            } else if (account === testAccount && password === testPassword) {
                return {
                    code: 200,
                    message: 'ç™»å½•æˆåŠŸ',
                    data: {
                        token: 'mock_token_' + Date.now(),
                        refreshToken: 'refresh_token_' + Date.now(),
                        userId: '123456',
                        username: account,
                        avatar: '',
                        role: 'doctor',
                        permissions: ['doctor'],
                        expiresIn: 86400
                    }
                };
            } else {
                throw { code: 400, message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' };
            }
        }

        // è¡¨å•æäº¤
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // éªŒè¯æ‰€æœ‰è¾“å…¥
            const accountValid = validateAccount();
            const passwordValid = validatePassword();
            const captchaValid = validateCaptcha();

            if (!accountValid || !passwordValid || (!captchaValid && captchaGroup.classList.contains('show'))) {
                return;
            }

            // æ£€æŸ¥é”å®šçŠ¶æ€
            if (isLocked) {
                showErrorMessage('è´¦å·å·²è¢«é”å®šï¼Œè¯·ç¨åå†è¯•');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loginButton.classList.add('loading');
            loginButton.disabled = true;
            accountInput.disabled = true;
            passwordInput.disabled = true;
            if (captchaGroup.classList.contains('show')) {
                captchaInput.disabled = true;
            }

            try {
                const account = accountInput.value.trim();
                const password = passwordInput.value;
                const captcha = captchaInput.value.trim();

                const response = await login(account, password, captcha);

                // ç™»å½•æˆåŠŸ
                if (response.code === 200) {
                    // æ¸…é™¤å¤±è´¥æ¬¡æ•°å’Œé”å®šçŠ¶æ€
                    localStorage.removeItem('failedAttempts');
                    localStorage.removeItem('lockUntil');
                    failedAttempts = 0;
                    isLocked = false;

                    // ä¿å­˜Tokenå’Œç”¨æˆ·ä¿¡æ¯
                    localStorage.setItem('token', response.data.token);
                    localStorage.setItem('refreshToken', response.data.refreshToken);
                    localStorage.setItem('userId', response.data.userId);
                    localStorage.setItem('username', response.data.username);
                    
                    // ä¿å­˜ç”¨æˆ·å®Œæ•´ä¿¡æ¯ï¼ˆåŒ…æ‹¬è§’è‰²å’Œæƒé™ï¼‰
                    const userInfo = {
                        username: response.data.username,
                        userId: response.data.userId,
                        role: response.data.role || 'doctor',
                        permissions: response.data.permissions || ['doctor']
                    };
                    localStorage.setItem('userInfo', JSON.stringify(userInfo));

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showSuccessMessage('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...');

                    // è·³è½¬åˆ°ä¸»é¡µ
                    setTimeout(() => {
                        window.location.href = 'é¡µé¢æ¡†æ¶.html';
                    }, 500);

                }
            } catch (error) {
                // ç™»å½•å¤±è´¥
                failedAttempts++;
                localStorage.setItem('failedAttempts', failedAttempts.toString());

                // æ˜¾ç¤ºé”™è¯¯
                showErrorMessage(error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                
                // æ¸…ç©ºå¯†ç æ¡†
                passwordInput.value = '';
                passwordInput.focus();

                // è¿ç»­å¤±è´¥3æ¬¡æ˜¾ç¤ºéªŒè¯ç 
                if (failedAttempts >= 3 && !captchaGroup.classList.contains('show')) {
                    showCaptcha();
                    captchaInput.focus();
                }

                // è¿ç»­å¤±è´¥5æ¬¡é”å®šè´¦å·30åˆ†é’Ÿ
                if (failedAttempts >= 5) {
                    const lockDate = new Date(Date.now() + 30 * 60 * 1000); // 30åˆ†é’Ÿå
                    localStorage.setItem('lockUntil', lockDate.toISOString());
                    isLocked = true;
                    lockUntil = lockDate;
                    showAccountLocked(lockDate);
                    showErrorMessage('è¿ç»­ç™»å½•å¤±è´¥5æ¬¡ï¼Œè´¦å·å·²è¢«é”å®š30åˆ†é’Ÿ');
                    
                    // é‡ç½®è¡¨å•çŠ¶æ€
                    loginButton.classList.remove('loading');
                    accountInput.disabled = true;
                    passwordInput.disabled = true;
                    loginButton.disabled = true;
                    return;
                }

                // é‡ç½®è¡¨å•çŠ¶æ€
                loginButton.classList.remove('loading');
                accountInput.disabled = false;
                passwordInput.disabled = false;
                if (captchaGroup.classList.contains('show')) {
                    captchaInput.disabled = false;
                    generateCaptcha();
                    captchaInput.value = '';
                    clearError(captchaInput, captchaError);
                }
                updateLoginButtonState();
            }
        });
    </script>
</body>
</html>
