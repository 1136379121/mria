<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>其他设备工作量统计 - 统计分析</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:#f5f5f5;
      color:#1f1f1f;
      padding:0;
      overflow:hidden;
    }
    :root{
      --primary:#1677ff;
      --border:#f0f0f0;
      --card:#fff;
      --muted:#8c8c8c;
      --shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .page{
      height: 100vh;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .header{
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: 0;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex: 0 0 auto;
    }
    .title{
      font-size: 18px;
      font-weight: 700;
      color:#333;
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 0;
    }
    .tabs{
      display:flex;
      align-items:center;
      gap: 16px;
    }
    .tab{
      font-size: 13px;
      color:#666;
      padding: 6px 0;
      cursor:pointer;
      border-bottom: 2px solid transparent;
      user-select:none;
    }
    .tab.active{
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 700;
    }
    .hidden{ display:none !important; }
    .filters{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .select, .input{
      height: 32px;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      padding: 0 10px;
      font-size: 13px;
      outline:none;
      background:#fff;
      color:#333;
    }
    .select{ min-width: 160px; }
    .input{
      width: 260px;
    }
    .select:focus, .input:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(22,119,255,.18);
    }
    .seg{
      display:flex;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      overflow:hidden;
      height: 32px;
      background:#fff;
    }
    .seg button{
      border: none;
      background: transparent;
      padding: 0 12px;
      height: 32px;
      font-size: 13px;
      cursor:pointer;
      color:#666;
    }
    .seg button.active{
      background: #e6f4ff;
      color: var(--primary);
      font-weight: 700;
    }
    .btn{
      height: 32px;
      padding: 0 12px;
      border-radius: 6px;
      border: 1px solid #d9d9d9;
      background:#fff;
      cursor:pointer;
      font-size: 13px;
      color:#333;
      user-select:none;
      transition: all .15s ease;
    }
    .btn:hover{ border-color: var(--primary); color: var(--primary); }
    .btn.sm{
      height: 24px;
      padding: 0 10px;
      font-size: 11px;
      border-radius: 6px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: 4px;
      font-size: 12px;
      line-height: 1;
      font-weight: 800;
      border: 1px solid transparent;
    }
    .badge.blue{ background:#e6f4ff; color: var(--primary); border-color:#bae0ff; }
    .tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 0 8px;
      height: 20px;
      border-radius: 999px;
      background:#e6f4ff;
      color: var(--primary);
      font-size: 12px;
      font-weight: 700;
    }
    .tag.gray{ background:#f5f5f5; color:#666; }
    .tag.blue{ background:#e6f4ff; color: var(--primary); }
    .tag.green{ background:#f6ffed; color:#389e0d; }
    .content{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      padding: 0 10px 10px 10px;
    }
    .card{
      background: var(--card);
      border-radius: 0;
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: 0;
    }

    /* 数据图：两列面板 */
    .panel-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      padding: 10px;
    }
    @media (max-width: 1100px){
      .panel-grid{ grid-template-columns: 1fr; }
    }
    .panel{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow:hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }
    .panel-hd{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#fff;
    }
    .panel-title{
      font-size: 13px;
      font-weight: 800;
      color:#333;
    }
    .panel-actions{ display:flex; align-items:center; gap: 8px; }
    .chart-wrap{ padding: 10px 12px 8px 12px; }
    .chart-box{
      height: 220px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background:#fff;
      /* 图例独占一行，绘图区在其下方 */
      padding: 8px 10px 10px 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      overflow:hidden;
    }
    .legend{
      position: static;
      width: 100%;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      font-size: 11px;
      color:#666;
      justify-content: flex-end;
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
    }
    .legend-item{ display:flex; align-items:center; gap: 6px; }
    .legend-dot{ width: 10px; height: 10px; border-radius: 2px; }
    .plot-area{
      position: relative;
      flex: 1 1 auto;
      min-height: 0;
      padding: 14px 10px 30px 48px;
      overflow:hidden;
    }
    .y-axis{
      position:absolute;
      left: 0;
      top: 12px;
      bottom: 24px;
      width: 42px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      font-size: 11px;
      color:#999;
      text-align:right;
      padding-right: 8px;
      pointer-events:none;
    }
    .bars{
      height: 100%;
      display:flex;
      align-items:flex-end;
      justify-content:space-around;
      gap: 10px;
    }
    .bar-group{
      flex: 1;
      max-width: 120px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
    }
    .bar-stack{
      width: 44px;
      display:flex;
      flex-direction: column-reverse;
      justify-content:flex-start;
      border-radius: 2px 2px 0 0;
      overflow:hidden;
      min-height: 2px;
      position: relative;
    }
    .seg-bar{ width: 100%; }
    .bar-total{
      position:absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      font-weight: 800;
      color:#333;
      white-space: nowrap;
      pointer-events:none;
    }
    .bar-label{
      font-size: 11px;
      color:#666;
      white-space: nowrap;
    }
    .data-table-wrap{
      border-top: 1px solid var(--border);
      background:#fff;
      overflow:auto;
    }
    /* 汇总表：执行统计 + 明细表 */
    .section{
      background:#fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow:hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
      margin: 10px;
    }
    .section-hd{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .section-title{
      font-size: 13px;
      font-weight: 800;
      color:#333;
    }
    .section-actions{ display:flex; align-items:center; gap: 8px; }
    .donut-zone{
      background:#fafafa;
      padding: 18px 12px;
      min-height: 220px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      position: relative;
    }
    .legend-col{
      flex: 0 0 320px;
      max-width: 360px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      font-size: 12px;
      color:#333;
      overflow:hidden;
    }
    .legend-row{
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .legend-dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      flex: 0 0 auto;
    }
    .legend-name{
      flex: 1 1 auto;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .legend-meta{
      color:#666;
      font-variant-numeric: tabular-nums;
    }
    .donut-wrap{
      flex: 1 1 auto;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .donut{
      width: 150px;
      height: 150px;
      border-radius: 999px;
      position: relative;
      background: conic-gradient(#5470C6 0 360deg);
    }
    .donut::after{
      content:"";
      position:absolute;
      inset: 26px;
      background:#fff;
      border-radius: 999px;
      border: 1px solid var(--border);
    }
    .donut-center{
      position:absolute;
      inset: 0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index: 1;
      gap: 2px;
    }
    .donut-center .n{
      font-size: 22px;
      font-weight: 900;
      color:#333;
      line-height: 1;
    }
    .donut-center .t{
      font-size: 12px;
      font-weight: 700;
      color:#666;
    }
    .table-wrap{
      overflow:auto;
      background:#fff;
    }
    table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 980px;
    }
    thead th{
      background:#fafafa;
      color:#333;
      font-weight: 700;
      font-size: 12px;
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      text-align:center;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody td{
      font-size: 12px;
      color:#333;
      padding: 10px 8px;
      border-bottom: 1px solid #f5f5f5;
      text-align:center;
      white-space: nowrap;
    }
    tbody tr:hover{ background:#fafcff; }
    .col-left{
      text-align:left !important;
      padding-left: 12px !important;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <div class="title">
        <span>其他设备工作量统计</span>
        <div class="tabs" role="tablist" aria-label="视图切换">
          <div class="tab active" id="tabChart">数据图</div>
          <div class="tab" id="tabTable">汇总表</div>
        </div>
      </div>
      <div class="filters">
        <span id="filterRoom">
          <select class="select" id="roomSelect">
            <option selected>定位室</option>
            <option>定位11</option>
            <option>定位室（时间段）</option>
            <option>test-时间段</option>
            <option>定位室 28</option>
          </select>
        </span>
        <span id="filterCampusDept">
          <select class="select" id="campusSelect" title="院区">
            <option value="all" selected>全部院区</option>
          </select>
          <select class="select" id="deptSelect" title="科室">
            <option value="all" selected>全部科室</option>
          </select>
        </span>
        <input class="input" id="dateRange" value="2025-07-01 至 2026-01-31" />
        <span id="filterGranularity">
          <div class="seg" role="group" aria-label="时间粒度">
            <button type="button" id="btnDay">按日</button>
            <button type="button" id="btnMonth" class="active">按月</button>
          </div>
        </span>
      </div>
    </div>

    <div class="content">
      <!-- 视图1：数据图（内容后续补充，先置空） -->
      <div class="card" id="viewChart">
        <div class="panel-grid">
          <!-- 预约统计 -->
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-title">预约统计</div>
              <div class="panel-actions">
                <button class="btn sm" data-action="detail" data-panel="booking">明细</button>
                <button class="btn sm" data-action="download" data-panel="booking">下载</button>
              </div>
            </div>
            <div class="chart-wrap">
              <div class="chart-box" aria-label="预约统计柱状图">
                <div class="legend" id="legendBooking"></div>
                <div class="plot-area">
                  <div class="y-axis" id="yAxisBooking"></div>
                  <div class="bars" id="barsBooking"></div>
                </div>
              </div>
            </div>
            <div class="data-table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width: 110px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="tbodyBooking"></tbody>
              </table>
            </div>
          </div>

          <!-- 执行统计 -->
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-title">执行统计</div>
              <div class="panel-actions">
                <button class="btn sm" data-action="detail" data-panel="execute">明细</button>
                <button class="btn sm" data-action="download" data-panel="execute">下载</button>
              </div>
            </div>
            <div class="chart-wrap">
              <div class="chart-box" aria-label="执行统计柱状图">
                <div class="legend" id="legendExecute"></div>
                <div class="plot-area">
                  <div class="y-axis" id="yAxisExecute"></div>
                  <div class="bars" id="barsExecute"></div>
                </div>
              </div>
            </div>
            <div class="data-table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width: 140px;"></th>
                    <th>2025-07</th><th>2025-08</th><th>2025-09</th><th>2025-10</th><th>2025-11</th><th>2025-12</th><th>2026-01</th>
                  </tr>
                </thead>
                <tbody id="tbodyExecute"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 视图2：汇总表（内容后续补充，先置空） -->
      <div class="card hidden" id="viewTable">
        <div class="section">
          <div class="section-hd">
            <div class="section-title">执行统计</div>
            <div class="section-actions"></div>
          </div>
          <div class="donut-zone">
            <div class="legend-col" id="legendLeft"></div>
            <div class="donut-wrap">
              <div class="donut" id="donutMain" aria-label="执行统计环形图">
                <div class="donut-center">
                  <div class="n" id="donutTotal">74</div>
                  <div class="t">总数</div>
                </div>
              </div>
            </div>
            <div class="legend-col" id="legendRight" style="align-items:flex-end;"></div>
          </div>
        </div>

        <div class="section">
          <div class="section-hd">
            <div class="section-title">汇总表</div>
            <div class="section-actions">
              <button class="btn sm" id="btnExportSummary">导出</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th class="col-left" style="width: 180px;">机房名称</th>
                  <th>后装计划设计</th>
                  <th>CT扫描</th>
                  <th>复位申请</th>
                  <th>定位执行</th>
                  <th>合计</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="col-left">定位室</td>
                  <td>1</td><td>0</td><td>0</td><td>41</td><td><span class="badge blue">42</span></td>
                </tr>
                <tr>
                  <td class="col-left">定位11</td>
                  <td>0</td><td>1</td><td>1</td><td>14</td><td><span class="badge blue">16</span></td>
                </tr>
                <tr>
                  <td class="col-left">定位室（时间段）</td>
                  <td>0</td><td>0</td><td>0</td><td>12</td><td><span class="badge blue">12</span></td>
                </tr>
                <tr>
                  <td class="col-left">test-时间段</td>
                  <td>0</td><td>0</td><td>0</td><td>3</td><td><span class="badge blue">3</span></td>
                </tr>
                <tr>
                  <td class="col-left">定位室 28</td>
                  <td>0</td><td>0</td><td>0</td><td>1</td><td><span class="badge blue">1</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const months = ['2025-07','2025-08','2025-09','2025-10','2025-11','2025-12','2026-01'];

    // -----------------------------
    // 顶部筛选：院区 / 科室（两视图共用）
    // 默认：全部院区 / 全部科室
    // -----------------------------
    const campusOptions = [
      { id: 'all', name: '全部院区' },
      { id: 'c1', name: '本部院区' },
      { id: 'c2', name: '东院区' }
    ];
    const deptOptions = [
      { id: 'all', campusId: 'all', name: '全部科室' },
      { id: 'd1', campusId: 'c1', name: '放疗科' },
      { id: 'd2', campusId: 'c1', name: '肿瘤科' },
      { id: 'd3', campusId: 'c2', name: '放疗科' },
      { id: 'd4', campusId: 'c2', name: '介入科' }
    ];

    function $(id){ return document.getElementById(id); }

    function updateDeptOptions(){
      const campusId = $('campusSelect')?.value || 'all';
      const deptSelect = $('deptSelect');
      if (!deptSelect) return;
      const prev = deptSelect.value || 'all';

      const list = deptOptions.filter(d => d.id === 'all' || campusId === 'all' || d.campusId === campusId);
      deptSelect.innerHTML = '';
      list.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.name;
        deptSelect.appendChild(opt);
      });

      const stillExists = Array.from(deptSelect.options).some(o => o.value === prev);
      deptSelect.value = stillExists ? prev : 'all';
    }

    function initCampusDeptFilters(){
      const campusSelect = $('campusSelect');
      if (campusSelect) {
        campusSelect.innerHTML = '';
        campusOptions.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name;
          campusSelect.appendChild(opt);
        });
        campusSelect.value = 'all';
      }
      updateDeptOptions();
    }

    function setGranularity(type){
      const btnDay = document.getElementById('btnDay');
      const btnMonth = document.getElementById('btnMonth');
      const isMonth = type === 'month';
      btnDay?.classList.toggle('active', !isMonth);
      btnMonth?.classList.toggle('active', isMonth);
      // 原型：按日/按月仅切换样式
    }

    function renderLegend(containerId, series){
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = series.map(s => `
        <span class="legend-item">
          <span class="legend-dot" style="background:${s.color}"></span>
          <span>${s.name}</span>
        </span>
      `).join('');
    }

    function renderYAxis(containerId, maxValue){
      const el = document.getElementById(containerId);
      if (!el) return;
      const max = Math.max(maxValue, 1);
      const ticks = max <= 1 ? [1,0] : [max, Math.floor(max/2), 0];
      el.innerHTML = ticks.map(t => `<div>${t}</div>`).join('');
    }

    function renderStackedBars({ barsId, yAxisId, legendId, data, series }){
      const barsEl = document.getElementById(barsId);
      if (!barsEl) return;
      renderLegend(legendId, series);
      const totals = data.map(d => series.reduce((sum, s) => sum + (d.values[s.name] || 0), 0));
      const max = Math.max(...totals, 1);
      renderYAxis(yAxisId, max);

      barsEl.innerHTML = '';
      data.forEach((d, idx) => {
        const total = totals[idx];
        const group = document.createElement('div');
        group.className = 'bar-group';

        const stack = document.createElement('div');
        stack.className = 'bar-stack';
        stack.style.height = ((total / max) * 160 + 6) + 'px';
        if (total > 0) {
          const t = document.createElement('div');
          t.className = 'bar-total';
          t.textContent = total;
          stack.appendChild(t);
        }
        series.forEach(s => {
          const v = d.values[s.name] || 0;
          if (v <= 0) return;
          const seg = document.createElement('div');
          seg.className = 'seg-bar';
          seg.style.height = total ? ((v / total) * 100) + '%' : '0%';
          seg.style.background = s.color;
          stack.appendChild(seg);
        });

        const label = document.createElement('div');
        label.className = 'bar-label';
        label.textContent = d.x;

        group.appendChild(stack);
        group.appendChild(label);
        barsEl.appendChild(group);
      });
    }

    function renderTableRows(tbodyId, rows){
      const el = document.getElementById(tbodyId);
      if (!el) return;
      el.innerHTML = rows.map(r => {
        const cells = months.map(m => `<td>${r.data[m] ?? 0}</td>`).join('');
        return `<tr><td><span class="tag ${r.tagClass || ''}">${r.name}</span></td>${cells}</tr>`;
      }).join('');
    }

    function initDataChart(){
      // 预约统计（已完成/未完成）
      const bookingSeries = [
        { name: '已完成', color: '#5470C6' },
        { name: '未完成', color: '#91CC75' }
      ];
      const bookingData = months.map(m => ({ x: m, values: { '已完成': 0, '未完成': 0 } }));
      // 参考截图
      bookingData.find(d => d.x==='2025-08').values['已完成'] = 1;
      bookingData.find(d => d.x==='2025-08').values['未完成'] = 1;
      bookingData.find(d => d.x==='2025-09').values['已完成'] = 1;
      bookingData.find(d => d.x==='2025-10').values['已完成'] = 1;
      bookingData.find(d => d.x==='2025-10').values['未完成'] = 1;
      bookingData.find(d => d.x==='2025-11').values['未完成'] = 1;
      bookingData.find(d => d.x==='2025-12').values['已完成'] = 2;
      renderStackedBars({
        barsId: 'barsBooking',
        yAxisId: 'yAxisBooking',
        legendId: 'legendBooking',
        data: bookingData,
        series: bookingSeries
      });
      renderTableRows('tbodyBooking', [
        { name: '已完成', tagClass: 'blue', data: {'2025-08':1,'2025-09':1,'2025-10':1,'2025-12':2} },
        { name: '未完成', tagClass: 'green', data: {'2025-08':1,'2025-10':1,'2025-11':1} },
        { name: '总计', tagClass: 'gray', data: {'2025-08':2,'2025-09':1,'2025-10':2,'2025-11':1,'2025-12':2} }
      ]);

      // 执行统计（后装计划设计/定位执行）
      const execSeries = [
        { name: '后装计划设计', color: '#5470C6' },
        { name: '定位执行', color: '#91CC75' }
      ];
      const execData = months.map(m => ({ x: m, values: { '后装计划设计': 0, '定位执行': 0 } }));
      execData.find(d => d.x==='2025-07').values['定位执行'] = 7;
      execData.find(d => d.x==='2025-09').values['定位执行'] = 7;
      execData.find(d => d.x==='2025-10').values['定位执行'] = 6;
      execData.find(d => d.x==='2025-11').values['定位执行'] = 10;
      execData.find(d => d.x==='2025-12').values['后装计划设计'] = 1;
      execData.find(d => d.x==='2025-12').values['定位执行'] = 9;
      execData.find(d => d.x==='2026-01').values['定位执行'] = 2;
      renderStackedBars({
        barsId: 'barsExecute',
        yAxisId: 'yAxisExecute',
        legendId: 'legendExecute',
        data: execData,
        series: execSeries
      });
      renderTableRows('tbodyExecute', [
        { name: '后装计划设计', tagClass: 'blue', data: {'2025-12':1} },
        { name: '定位执行', tagClass: 'green', data: {'2025-07':7,'2025-09':7,'2025-10':6,'2025-11':10,'2025-12':9,'2026-01':2} },
        { name: '总计', tagClass: 'gray', data: {'2025-07':7,'2025-09':7,'2025-10':6,'2025-11':10,'2025-12':10,'2026-01':2} }
      ]);
    }

    function renderDonut(elId, totalElId, leftLegendId, rightLegendId, items, rightFirstName) {
      // items: [{name,value,color}], rightFirstName: string -> 渲染到右侧（与截图一致）
      const donut = document.getElementById(elId);
      const totalEl = document.getElementById(totalElId);
      const leftLegend = document.getElementById(leftLegendId);
      const rightLegend = document.getElementById(rightLegendId);
      if (!donut || !totalEl || !leftLegend || !rightLegend) return;

      const total = items.reduce((s, it) => s + it.value, 0) || 1;
      totalEl.textContent = total;

      let acc = 0;
      const parts = items.map(it => {
        const start = acc;
        const pct = (it.value / total) * 100;
        acc += pct;
        return `${it.color} ${start.toFixed(4)}% ${acc.toFixed(4)}%`;
      });
      donut.style.background = `conic-gradient(${parts.join(',')})`;

      const buildRow = (it) => {
        const pct = (it.value / total) * 100;
        return `
          <div class="legend-row">
            <span class="legend-dot" style="background:${it.color}"></span>
            <span class="legend-name">${it.name}</span>
            <span class="legend-meta">${it.value}次</span>
            <span class="legend-meta">(${pct.toFixed(2)}%)</span>
          </div>
        `;
      };

      const rightItem = items.find(x => x.name === rightFirstName) || items[0];
      const leftItems = items.filter(x => x !== rightItem);
      leftLegend.innerHTML = leftItems.map(buildRow).join('');
      rightLegend.innerHTML = rightItem ? buildRow(rightItem) : '';
    }

    function initSummary() {
      // 参考截图：右侧突出“定位室”，左侧列表其余项目
      renderDonut(
        'donutMain',
        'donutTotal',
        'legendLeft',
        'legendRight',
        [
          { name: '定位室', value: 42, color: '#5470C6' },
          { name: '定位11', value: 16, color: '#91CC75' },
          { name: '定位室（时间段）', value: 12, color: '#FAC858' },
          { name: 'test-时间段', value: 3, color: '#EE6666' },
          { name: '定位室 28', value: 1, color: '#73C0DE' }
        ],
        '定位室'
      );
    }

    function setView(view) {
      const chart = document.getElementById('viewChart');
      const table = document.getElementById('viewTable');
      const tabChart = document.getElementById('tabChart');
      const tabTable = document.getElementById('tabTable');
      const filterCampusDept = document.getElementById('filterCampusDept');
      const filterRoom = document.getElementById('filterRoom');
      const filterGranularity = document.getElementById('filterGranularity');

      const isChart = view === 'chart';
      chart.classList.toggle('hidden', !isChart);
      table.classList.toggle('hidden', isChart);
      tabChart.classList.toggle('active', isChart);
      tabTable.classList.toggle('active', !isChart);

      // 汇总表截图中仅保留日期范围（本次新增：院区/科室两视图均显示）
      filterCampusDept?.classList.toggle('hidden', false);
      filterRoom?.classList.toggle('hidden', !isChart);
      filterGranularity?.classList.toggle('hidden', !isChart);
    }

    initCampusDeptFilters();
    $('campusSelect')?.addEventListener('change', () => { updateDeptOptions(); /* 原型占位：触发刷新 */ });

    setView('chart');
    document.getElementById('tabChart').addEventListener('click', () => setView('chart'));
    document.getElementById('tabTable').addEventListener('click', () => setView('table'));

    initSummary();
    initDataChart();
    document.getElementById('btnDay')?.addEventListener('click', () => setGranularity('day'));
    document.getElementById('btnMonth')?.addEventListener('click', () => setGranularity('month'));
    document.getElementById('btnExportSummary')?.addEventListener('click', () => alert('原型占位：导出'));

    document.body.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const act = btn.getAttribute('data-action');
      const panel = btn.getAttribute('data-panel');
      const map = {
        detail: '原型占位：明细',
        download: '原型占位：下载'
      };
      alert(`${map[act] || '原型占位'}（${panel || ''}）`);
    });
  </script>
</body>
</html>

