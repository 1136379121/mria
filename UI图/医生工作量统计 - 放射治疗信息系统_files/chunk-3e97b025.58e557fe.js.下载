(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3e97b025"],{"5ba4":function(t,e,i){},"82f4":function(t,e,i){},9604:function(t,e,i){"use strict";i("5ba4")},e517:function(t,e,i){"use strict";i("82f4")},fe9f:function(t,e,i){"use strict";var n=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",[n("input",{ref:"uploadPhotoInput",staticClass:"upload-photo-input",attrs:{type:"file",accept:"image/*"},on:{change:t.handleUploadPhotoChange}}),t._v(" "),n("el-dialog",{directives:[{name:"loading",rawName:"v-loading.lock",value:!0,expression:"true",modifiers:{lock:!0}}],staticClass:"period-dialog",attrs:{title:t.isUploadMode?"上传":"拍照",visible:t.isVisible,"before-close":t.close,"close-on-click-modal":!1,width:"24%","append-to-body":""},on:{"update:visible":function(e){t.isVisible=e}}},[n("div",{staticClass:"main"},[n("div",{staticClass:"box"},[n("div",{directives:[{name:"show",rawName:"v-show",value:!t.isImgCanvas,expression:"!isImgCanvas"},{name:"loading",rawName:"v-loading",value:!t.isPhotoAvailable,expression:"!isPhotoAvailable"}],staticClass:"carmebox"},[n("video",{ref:"video",attrs:{id:"video"}}),t._v(" "),n("canvas",{ref:"videoCanvas",attrs:{id:"video-canvas"}}),t._v(" "),n("img",{staticClass:"video-avatar-range",attrs:{src:i("8790")}})]),t._v(" "),n("div",{directives:[{name:"show",rawName:"v-show",value:t.isImgCanvas,expression:"isImgCanvas"}],staticClass:"photobox"},[n("div",{staticClass:"imgCanvas"},[n("div",{staticClass:"imgCanvasBgWrapper"},[n("canvas",{ref:"imgCanvas",attrs:{id:"image-canvas",width:"300",height:"300"}}),t._v(" "),n("img",{staticClass:"image-avatar-range",attrs:{src:i("8790")}})]),t._v(" "),n("div",{staticClass:"slider-wrapper"},[n("el-tooltip",{attrs:{effect:"dark",content:t.$l("zoom_out"),placement:"bottom"}},[n("img",{attrs:{src:i("b7f2")},on:{click:t.zoomOut}})]),t._v(" "),n("el-slider",{attrs:{min:t.slider.min,max:t.slider.max,step:t.slider.step,"show-tooltip":!1},on:{input:t.scale},model:{value:t.slider.maxScale,callback:function(e){t.$set(t.slider,"maxScale",e)},expression:"slider.maxScale"}}),t._v(" "),n("el-tooltip",{attrs:{effect:"dark",content:t.$l("zoom_in"),placement:"bottom"}},[n("img",{attrs:{src:i("d7fc")},on:{click:t.zoomIn}})])],1)])]),t._v(" "),n("canvas",{ref:"resultCanvas",attrs:{id:"result-canvas",width:"300",height:"300"}})])]),t._v(" "),n("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t.isUploadMode?n("mt-button",{attrs:{type:"submain"},on:{click:t.uploadPatientPicture}},[t._v("\n        重新上传\n      ")]):n("mt-button",{key:t.isSaveAvailable,attrs:{type:t.isSaveAvailable?"submain":"primary",disabled:!t.isPhotoAvailable},on:{click:t.getPhoto}},[t._v("\n        "+t._s(t.isSaveAvailable?"重新拍照":"拍照")+"\n      ")]),t._v(" "),t.isSaveAvailable?n("mt-button",{staticClass:"mt-button",attrs:{type:"primary",loading:t.loading},on:{click:t.save}},[t._v(t._s(t.$l("save")))]):t._e()],1)])],1)},a=[],r=(i("a4d3"),i("e01a"),i("b636"),i("d28b"),i("944a"),i("d9e2"),i("caad"),i("e260"),i("14d9"),i("fb6a"),i("b0c0"),i("e9f5"),i("db9b"),i("7d54"),i("0c47"),i("23dc"),i("3410"),i("1f68"),i("131a"),i("d3b7"),i("e6cf"),i("3ca3"),i("159b"),i("ddb0"),i("365c")),o=i("5f87"),s=i("ed08");function c(t){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c(t)}function l(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */l=function(){return e};var t,e={},i=Object.prototype,n=i.hasOwnProperty,a=Object.defineProperty||function(t,e,i){t[e]=i.value},r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",s=r.asyncIterator||"@@asyncIterator",u=r.toStringTag||"@@toStringTag";function h(t,e,i){return Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{h({},"")}catch(t){h=function(t,e,i){return t[e]=i}}function d(t,e,i,n){var r=e&&e.prototype instanceof w?e:w,o=Object.create(r.prototype),s=new j(n||[]);return a(o,"_invoke",{value:E(t,i,s)}),o}function v(t,e,i){try{return{type:"normal",arg:t.call(e,i)}}catch(t){return{type:"throw",arg:t}}}e.wrap=d;var f="suspendedStart",p="suspendedYield",g="executing",m="completed",y={};function w(){}function b(){}function C(){}var x={};h(x,o,(function(){return this}));var _=Object.getPrototypeOf,I=_&&_(_(A([])));I&&I!==i&&n.call(I,o)&&(x=I);var k=C.prototype=w.prototype=Object.create(x);function L(t){["next","throw","return"].forEach((function(e){h(t,e,(function(t){return this._invoke(e,t)}))}))}function P(t,e){function i(a,r,o,s){var l=v(t[a],t,r);if("throw"!==l.type){var u=l.arg,h=u.value;return h&&"object"==c(h)&&n.call(h,"__await")?e.resolve(h.__await).then((function(t){i("next",t,o,s)}),(function(t){i("throw",t,o,s)})):e.resolve(h).then((function(t){u.value=t,o(u)}),(function(t){return i("throw",t,o,s)}))}s(l.arg)}var r;a(this,"_invoke",{value:function(t,n){function a(){return new e((function(e,a){i(t,n,e,a)}))}return r=r?r.then(a,a):a()}})}function E(e,i,n){var a=f;return function(r,o){if(a===g)throw Error("Generator is already running");if(a===m){if("throw"===r)throw o;return{value:t,done:!0}}for(n.method=r,n.arg=o;;){var s=n.delegate;if(s){var c=S(s,n);if(c){if(c===y)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(a===f)throw a=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a=g;var l=v(e,i,n);if("normal"===l.type){if(a=n.done?m:p,l.arg===y)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(a=m,n.method="throw",n.arg=l.arg)}}}function S(e,i){var n=i.method,a=e.iterator[n];if(a===t)return i.delegate=null,"throw"===n&&e.iterator.return&&(i.method="return",i.arg=t,S(e,i),"throw"===i.method)||"return"!==n&&(i.method="throw",i.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var r=v(a,e.iterator,i.arg);if("throw"===r.type)return i.method="throw",i.arg=r.arg,i.delegate=null,y;var o=r.arg;return o?o.done?(i[e.resultName]=o.value,i.next=e.nextLoc,"return"!==i.method&&(i.method="next",i.arg=t),i.delegate=null,y):o:(i.method="throw",i.arg=new TypeError("iterator result is not an object"),i.delegate=null,y)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function $(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function j(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function A(e){if(e||""===e){var i=e[o];if(i)return i.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,r=function i(){for(;++a<e.length;)if(n.call(e,a))return i.value=e[a],i.done=!1,i;return i.value=t,i.done=!0,i};return r.next=r}}throw new TypeError(c(e)+" is not iterable")}return b.prototype=C,a(k,"constructor",{value:C,configurable:!0}),a(C,"constructor",{value:b,configurable:!0}),b.displayName=h(C,u,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===b||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,C):(t.__proto__=C,h(t,u,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},L(P.prototype),h(P.prototype,s,(function(){return this})),e.AsyncIterator=P,e.async=function(t,i,n,a,r){void 0===r&&(r=Promise);var o=new P(d(t,i,n,a),r);return e.isGeneratorFunction(i)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},L(k),h(k,u,"Generator"),h(k,o,(function(){return this})),h(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),i=[];for(var n in e)i.push(n);return i.reverse(),function t(){for(;i.length;){var n=i.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=A,j.prototype={constructor:j,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach($),!e)for(var i in this)"t"===i.charAt(0)&&n.call(this,i)&&!isNaN(+i.slice(1))&&(this[i]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var i=this;function a(n,a){return s.type="throw",s.arg=e,i.next=n,a&&(i.method="next",i.arg=t),!!a}for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],s=o.completion;if("root"===o.tryLoc)return a("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),l=n.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return a(o.catchLoc,!0);if(this.prev<o.finallyLoc)return a(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return a(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return a(o.finallyLoc)}}}},abrupt:function(t,e){for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var r=a;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=e&&e<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=e,r?(this.method="next",this.next=r.finallyLoc,y):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.finallyLoc===t)return this.complete(i.completion,i.afterLoc),$(i),y}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.tryLoc===t){var n=i.completion;if("throw"===n.type){var a=n.arg;$(i)}return a}}throw Error("illegal catch attempt")},delegateYield:function(e,i,n){return this.delegate={iterator:A(e),resultName:i,nextLoc:n},"next"===this.method&&(this.arg=t),y}},e}function u(t,e,i,n,a,r,o){try{var s=t[r](o),c=s.value}catch(t){return void i(t)}s.done?e(c):Promise.resolve(c).then(n,a)}function h(t){return function(){var e=this,i=arguments;return new Promise((function(n,a){var r=t.apply(e,i);function o(t){u(r,n,a,o,s,"next",t)}function s(t){u(r,n,a,o,s,"throw",t)}o(void 0)}))}}var d=new Image,v=1,f=1,p=1,g=!1,m=null,y=null,w=0,b=0,C={name:"getPhoto",props:{patientInfo:{type:Object,default:function(){return null}}},data:function(){return{isVisible:!1,slider:{min:null,max:null,maxScale:null,step:null},video:{},stream:null,videoCanvas:{width:null,height:null,getCtx:null},imgCanvas:{},resultCanvas:{},loading:!1,imgUrl:null,isPhotoAvailable:!1,isImgCanvas:!1,face_id:"",isUploadMode:!1}},computed:{isSaveAvailable:function(){return!!this.isImgCanvas}},methods:{open:function(){this.init()},drop:function(t){if(!0===g){g=!1;var e=this.checkPosition(t.clientX-m,t.clientY-y);w=e.X,b=e.Y}},init:function(){var t=arguments,e=this;return h(l().mark((function i(){var n,a;return l().wrap((function(i){while(1)switch(i.prev=i.next){case 0:if(n=t.length>0&&void 0!==t[0]&&t[0],e.isUploadMode=n,e.isUploadMode){i.next=15;break}return i.prev=3,i.next=6,navigator.mediaDevices.getUserMedia({video:!0,audio:!1});case 6:e.stream=i.sent,i.next=15;break;case 9:return i.prev=9,i.t0=i["catch"](3),console.log("err",i.t0,i.t0.code),a=0===i.t0.code?e.$l("please_turn_on_the_camera"):e.$l("no_photography_device_found"),e.$confirm(a,e.$l("tips"),{confirmButtonText:e.$l("confirm"),cancelButtonText:e.$l("cancel"),showCancelButton:!1,type:""}).then((function(){e.close()})),i.abrupt("return");case 15:e.isVisible=!0,e.$nextTick((function(){e.video=e.$refs.video,e.videoCanvas=e.$refs.videoCanvas,e.videoCanvas.getCtx=e.videoCanvas.getContext("2d"),e.imgCanvas=e.$refs.imgCanvas,e.imgCanvas.getCtx=e.imgCanvas.getContext("2d"),e.resultCanvas=e.$refs.resultCanvas,e.resultCanvas.getCtx=e.resultCanvas.getContext("2d"),e.isUploadMode||(e.video.srcObject=e.stream,e.video.addEventListener("loadedmetadata",(function(){e.video.play(),e.isPhotoAvailable=!0}),!1)),e.imgCanvas.onmousedown=function(t){g=!0,m=t.clientX,y=t.clientY},window.addEventListener("mouseup",e.drop)})),window.addEventListener("mousemove",(function(t){if(g){var i=t.clientX-m,n=t.clientY-y;e.redrawImg(i,n)}}));case 18:case"end":return i.stop()}}),i,null,[[3,9]])})))()},viewImg:function(){this.resultCanvas.getCtx.drawImage(d,w,b,d.width*p,d.height*p)},close:function(){this.isVisible=!1,this.isImgCanvas=!1},getPhoto:function(){this.isImgCanvas=!this.isImgCanvas,this.imgCanvas.height=300,this.resultCanvas.height=300;var t=this.video.videoWidth,e=this.video.videoWidth/this.video.videoHeight;this.videoCanvas.width=2*t,this.videoCanvas.height=t/e*2,this.videoCanvas.getCtx.drawImage(this.video,0,0,this.videoCanvas.width,this.videoCanvas.height);var i=this.videoCanvas.toDataURL("image/jpeg");this.getImage(i)},drawMask:function(){this.imgCanvas.getCtx.fillStyle="rgba(0,0,0,0.5)",this.imgCanvas.getCtx.fillRect(0,0,300,300),this.imgCanvas.getCtx.fillStyle="rgba(0,0,0,1)",this.imgCanvas.getCtx.globalCompositeOperation="destination-out",this.imgCanvas.getCtx.fillRect(50,50,200,200)},getImage:function(t){var e=this;d.src=t,d.onload=function(){e.calcRatio();var t=e.canvasOriginPosition();e.imgCanvas.getCtx.globalCompositeOperation="destination-over",e.imgCanvas.getCtx.drawImage(d,t.positionX,t.positionY,d.width*p,d.height*p)}},canvasOriginPosition:function(){var t,e;return this.calcRatio(),d.width<d.height?(t=0,e=-(d.height*p-300)/2):(t=-(d.width*p-300)/2,e=0),w=t,b=e,{positionX:t,positionY:e}},calcRatio:function(){d.width<d.height?(v=300/d.width,p=300/d.width,f=500/d.width):(v=300/d.height,p=300/d.height,f=500/d.height),this.initSlider()},initSlider:function(){this.slider.min=v,this.slider.max=f,this.slider.step=.01,this.slider.maxScale=p},redrawImg:function(t,e){var i=this.checkPosition(t,e);this.imgCanvas.height=300,this.imgCanvas.getCtx.globalCompositeOperation="destination-over",this.imgCanvas.getCtx.drawImage(d,i.X,i.Y,d.width*p,d.height*p)},scale:function(){p=this.slider.maxScale,console.log(11111,p),this.redrawImg(0,0)},zoomIn:function(){var t=this.slider.step;this.slider.maxScale=this.slider.maxScale+t,this.redrawImg(0,0)},zoomOut:function(){var t=this.slider.step;this.slider.maxScale=this.slider.maxScale-t,this.redrawImg(0,0)},checkPosition:function(t,e){if(t+w<=0&&t+w>=300-d.width*p&&e+b<=0&&e+b>=300-d.height*p)return{X:t+w,Y:e+b};var i=t+w,n=e+b;return t+w>0&&(i=0),t+w<300-d.width*p&&(i=300-d.width*p),e+b>0&&(n=0),e+b<300-d.height*p&&(n=300-d.height*p),{X:i,Y:n}},save:function(){var t=this;return h(l().mark((function e(){var i,n,a,c,u,h,d,v;return l().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.viewImg(),i=t.resultCanvas.toDataURL("image/png"),t.loading=!0,n=new Image,n.src=i,a=new FormData,a.append("hospital_code",t.$store.state.user.hospitalCode),a.append("action_user_code",t.$store.state.user.userInfo.user_code),a.append("action_client_code",SETTING.actionCodeValue),a.append("access_token",Object(o["a"])()),a.append("file",Object(s["c"])(i,"avatar.jpg")),c=r["a"].UPLOAD_PATIENT_IMAGE,t.patientInfo&&(u=t.patientInfo,h=u.id_number,d=u.patient_visit_code,a.append("id_number",h),a.append("patient_visit_code",d),c=r["a"].UPDATE_PATIENT_IMAGE),e.prev=13,e.next=16,t.$request.post(c,a,{headers:{"Content-Type":"multipart/form-data"}});case 16:if(v=e.sent,t.loading=!1,1e4===v.code){e.next=20;break}return e.abrupt("return");case 20:t.isVisible=!1,t.$mtMessage({type:"success",message:"保存成功"}),setTimeout((function(){var e=v.data,i=e.file_id,n=e.face_id,a=SETTING.FlowSystemApi+"/get_patient_image?file_id=".concat(i);t.face_id=n||"",t.$emit("set",{imgUrl:a,face_id:t.face_id}),t.isImgCanvas=!1}),500),e.next=28;break;case 25:e.prev=25,e.t0=e["catch"](13),t.loading=!1;case 28:case"end":return e.stop()}}),e,null,[[13,25]])})))()},uploadPatientPicture:function(){this.$refs.uploadPhotoInput.click()},handleUploadPhotoChange:function(t){var e=this,i=t.target.files[0];if(i){var n=i.type,a=i.size,r=["image/jpeg","image/png","image/jpg","image/bmp"],o=2097152;if(r.includes(n))if(a>o)this.$mtMessage({type:"error",message:"图片大小超过2M"});else{this.isVisible||this.init(!0),this.isImgCanvas=!0,this.imgCanvas.height=300,this.resultCanvas.height=300;var s=new FileReader;s.readAsDataURL(i),s.onload=function(t){e.getImage(t.target.result)},this.$refs.uploadPhotoInput.value=""}else this.$mtMessage({type:"error",message:"暂不支持此文件格式"})}}}},x=C,_=(i("e517"),i("9604"),i("2877")),I=Object(_["a"])(x,n,a,!1,null,"23ea9bde",null);e["a"]=I.exports}}]);